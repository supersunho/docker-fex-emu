ARG FEX_VERSION
ARG BASE_IMAGE=fedora:40

#==============================================
# Sources Stage - Clone FEX with submodules
#==============================================
FROM alpine:latest AS fex-sources

ARG FEX_VERSION

# Install git and clone FEX with submodules
RUN apk add --no-cache git && \
    echo "ğŸ” Cloning FEX source with submodules..." && \
    git clone --recursive --depth 1 --branch ${FEX_VERSION} https://github.com/FEX-Emu/FEX /tmp/fex-source && \
    echo "âœ… FEX source with submodules cloned successfully"

#==============================================
# Build Stage - Fedora Base
#==============================================
FROM fedora:40 AS fex-builder

ARG TARGETPLATFORM
ARG ROOTFS_OS=fedora
ARG ROOTFS_VERSION="40"
ARG LLVM_VERSION=18
ARG CCACHE_DIR=/tmp/.ccache
ARG ENABLE_CCACHE=false

# Set environment variables for ccache
ENV CCACHE_DIR=${CCACHE_DIR}
ENV ENABLE_CCACHE=${ENABLE_CCACHE}
ENV TZ=Asia/Seoul

LABEL org.opencontainers.image.version="${FEX_VERSION}"
LABEL fex.emulator.version="${FEX_VERSION}"
LABEL build.platform="${TARGETPLATFORM}"
LABEL build.date="$(date -u +'%Y-%m-%dT%H:%M:%SZ')"

# Configure Fedora environment for FEX build
RUN echo "ğŸ” Setting up Fedora 40 build environment..." && \
    echo "ğŸ—ï¸ Configuring Fedora for maximum compatibility..." && \
    ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && \
    echo $TZ > /etc/timezone && \
    echo "âœ… Fedora environment configuration completed"

# Install build dependencies with Fedora packages
RUN --mount=type=cache,target=/var/cache/dnf,sharing=locked \
    echo "ğŸ“¦ Installing Fedora build packages..." && \
    echo "ğŸ” Using Fedora 40 packages for maximum stability..." && \
    dnf update -y -q && \
    echo "ğŸ“¦ Installing development packages..." && \
    dnf install -y -q \
        git cmake ninja-build pkgconfig ccache \
        nasm python3-devel python3-clang python3-setuptools \
        curl wget \
        openssl-devel \
        squashfs-tools erofs-utils \
        qt5-qtbase-devel qt5-linguist \
        >/dev/null 2>&1 && \
    echo "âœ… Base packages installed successfully" && \
    \
    # Install LLVM ${LLVM_VERSION} from Fedora repositories
    echo "ğŸ”§ Installing LLVM ${LLVM_VERSION} from Fedora repositories..." && \
    dnf install -y -q \
        clang-${LLVM_VERSION} \
        lld-${LLVM_VERSION} \
        llvm-${LLVM_VERSION} \
        llvm-${LLVM_VERSION}-devel \
        llvm-${LLVM_VERSION}-static \
        >/dev/null 2>&1 && \
    echo "âœ… LLVM ${LLVM_VERSION} installed from Fedora repository" && \
    \
    # Verify final installation
    echo "ğŸ” Verifying LLVM ${LLVM_VERSION} installation..." && \
    clang-${LLVM_VERSION} --version && \
    echo "âœ… LLVM ${LLVM_VERSION} verification completed" && \
    \
    echo "ğŸ¯ Installing critical FEX JIT dependencies..." && \
    dnf install -y -q \
        libunwind-devel \
        glibc-devel \
        gcc \
        gcc-c++ \
        >/dev/null 2>&1 && \
    \
    echo "âœ… All RootFS tools and dependencies installed successfully" && \
    \
    # Fedora cleanup
    echo "ğŸ§¹ Cleaning up Fedora packages..." && \
    alternatives --install /usr/bin/lld lld /usr/bin/lld-${LLVM_VERSION} 100 && \
    dnf clean all -q && \
    rm -rf /var/tmp/* && \
    echo "âœ… Fedora build environment setup completed successfully"

# ccache setup for Fedora
RUN echo "ğŸ“¦ Setting up ccache for Fedora build..." && \
    echo "ğŸ” Fedora system information:" && \
    echo "  - GLIBC version: $(ldd --version | head -1)" && \
    echo "  - Fedora version: $(cat /etc/fedora-release)" && \
    echo "  - Architecture: $(uname -m)" && \
    echo "  - Target RootFS: ${ROOTFS_OS}-${ROOTFS_VERSION}" && \
    \
    if [ "${ENABLE_CCACHE:-false}" = "true" ] && command -v ccache >/dev/null 2>&1; then \
        echo "ğŸ”„ Using Fedora ccache..." && \
        echo "CCACHE_SOURCE=system" > /tmp/ccache-info && \
        echo "âœ… Fedora ccache found and configured"; \
    else \
        echo "â„¹ï¸ ccache disabled or not available" && \
        echo "CCACHE_SOURCE=disabled" > /tmp/ccache-info; \
    fi && \
    \
    echo "âœ… Fedora ccache setup completed"

ENV PATH="/usr/local/bin/:$PATH"

# Copy FEX source from build context and build with Fedora
COPY --from=fex-sources / /tmp/fex-source
# Patch CMakeLists.txt files to conditionally include unittests when BUILD_TESTS=True
# This addresses the issue where add_subdirectory(unittests) is called unconditionally
# causing the build to fail when tests are disabled but the unittests directory exists
RUN echo "ğŸ” Patching CMakeLists.txt files to conditionally include unittests..." && \
    # Patch root CMakeLists.txt to conditionally include unittests
    sed -i 's/add_subdirectory(unittests)/if(BUILD_TESTS)\n  add_subdirectory(unittests)\nendif()/' /tmp/fex-source/CMakeLists.txt && \
    if grep -q "add_subdirectory(unittests)" /tmp/fex-source/FEXCore/CMakeLists.txt 2>/dev/null; then \
        sed -i 's/add_subdirectory(unittests)/if(BUILD_TESTS)\n  add_subdirectory(unittests)\nendif()/' /tmp/fex-source/FEXCore/CMakeLists.txt; \
    fi && \
    echo "âœ… CMakeLists.txt files patched successfully" && \
    \
    \
RUN --mount=type=cache,target=/tmp/.ccache \
    echo "ğŸ—ï¸ Starting FEX build process on Fedora..." && \
    echo "ğŸ·ï¸ Building FEX version: ${FEX_VERSION}" && \
    echo "ğŸ¯ Target platform: ${TARGETPLATFORM}" && \
    echo "ğŸ“Š Fedora build configuration:" && \
    echo "  - Base: Fedora 40" && \
    echo "  - Target RootFS: ${ROOTFS_OS}-${ROOTFS_VERSION}" && \
    echo "  - Build type: Release with LTO" && \
    cd /tmp/fex-source && \
    \
    # Check ccache setup
    . /tmp/ccache-info && \
    echo "ğŸ“Š Fedora build environment summary:" && \
    echo "  - ENABLE_CCACHE: ${ENABLE_CCACHE}" && \
    echo "  - CCACHE_SOURCE: ${CCACHE_SOURCE}" && \
    echo "  - LLVM_VERSION: ${LLVM_VERSION}" && \
    echo "  - CCACHE_BINARY: $(which ccache 2>/dev/null || echo 'not found')" && \
    echo "  - Build directory: $(pwd)" && \
    \
    mkdir -p Build && cd Build && \
    \
    # Fedora compiler detection
    echo "ğŸ” Detecting Fedora compilers..." && \
    if command -v clang-${LLVM_VERSION} >/dev/null 2>&1; then \
        CC_COMPILER=clang-${LLVM_VERSION} && \
        CXX_COMPILER=clang++-${LLVM_VERSION} && \
        echo "ğŸ¯ Found version-specific Fedora compilers"; \
    else \
        CC_COMPILER=clang && \
        CXX_COMPILER=clang++ && \
        echo "ğŸ”„ Using default Fedora compiler names"; \
    fi && \
    echo "âœ… Fedora compilers configured: $CC_COMPILER / $CXX_COMPILER" && \
    \
    # Fedora AR tools detection
    echo "ğŸ” Detecting Fedora archiver tools..." && \
    if command -v llvm-ar-${LLVM_VERSION} >/dev/null 2>&1; then \
        AR_TOOL=$(which llvm-ar-${LLVM_VERSION}) && \
        RANLIB_TOOL=$(which llvm-ranlib-${LLVM_VERSION}) && \
        echo "ğŸ¯ Found LLVM-specific Fedora tools"; \
    else \
        AR_TOOL=$(which ar) && \
        RANLIB_TOOL=$(which ranlib) && \
        echo "ğŸ”„ Using Fedora default tools"; \
    fi && \
    echo "âœ… Fedora archiver tools configured: $AR_TOOL" && \
    \
    # Enhanced ccache configuration for Fedora
    if [ "${ENABLE_CCACHE:-false}" = "true" ] && [ "${CCACHE_SOURCE}" != "disabled" ]; then \
        echo "ğŸš€ Configuring ccache acceleration for Fedora..." && \
        export CCACHE_BASEDIR=/tmp/fex-source && \
        export CCACHE_DIR=/tmp/.ccache && \
        export CCACHE_MAXSIZE=2G && \
        export CCACHE_SLOPPINESS=pch_defines,time_macros && \
        export CC="ccache $CC_COMPILER" && \
        export CXX="ccache $CXX_COMPILER" && \
        ccache --zero-stats && \        
        CCACHE_CMAKE_ARGS="-DCMAKE_C_COMPILER_LAUNCHER=ccache -DCMAKE_CXX_COMPILER_LAUNCHER=ccache" && \
        echo "âœ… ccache enabled with Fedora optimizations"; \
    else \
        CCACHE_CMAKE_ARGS="" && \
        echo "â„¹ï¸ ccache disabled for this Fedora build"; \
    fi && \
    \
    # Fedora-optimized CMake configuration
    echo "âš™ï¸ Running CMake configuration for Fedora..." && \
    echo "ğŸ¯ Optimizing for Fedora stability and compatibility..." && \
    cmake \
        -DCMAKE_INSTALL_PREFIX=/usr/local/fex \
        -DCMAKE_BUILD_TYPE=Release \
        -DUSE_LINKER=lld \
        -DENABLE_LTO=True \
        -DBUILD_TESTS=False \
        -DENABLE_ASSERTIONS=False \
        -DCMAKE_C_COMPILER="$CC_COMPILER" \
        -DCMAKE_CXX_COMPILER="$CXX_COMPILER" \
        $CCACHE_CMAKE_ARGS \
        -DCMAKE_AR="$AR_TOOL" \
        -DCMAKE_RANLIB="$RANLIB_TOOL" \
        -DCMAKE_C_COMPILER_AR="$AR_TOOL" \
        -DCMAKE_CXX_COMPILER_AR="$AR_TOOL" \
        -DCMAKE_EXE_LINKER_FLAGS="-static-libgcc -static-libstdc++" \
        -DCMAKE_SHARED_LINKER_FLAGS="-static-libgcc -static-libstdc++" \
        -G Ninja .. && \
    echo "âœ… CMake configuration completed for Fedora" && \
    \
    echo "ğŸ”¨ Starting compilation on Fedora..." && \
    echo "ğŸš€ Building FEX with $(nproc) CPU cores..." && \
    ninja -j$(($(nproc) - 1)) && \
    echo "âœ… Compilation completed successfully on Fedora" && \
    \
    echo "ğŸ“¦ Installing FEX binaries..." && \
    ninja install && \
    echo "âœ… FEX installation completed" && \
    \
    # Show ccache statistics if enabled
    if [ "${ENABLE_CCACHE:-false}" = "true" ] && [ "${CCACHE_SOURCE}" != "disabled" ]; then \
        echo "ğŸ“Š Fedora ccache Statistics:" && \
        ccache --show-stats; \
    fi && \
    \
    echo "ğŸ§¹ Cleaning up Fedora build artifacts..." && \
    rm -rf /tmp/fex-source /tmp/ccache-info && \
    echo "ğŸ‰ FEX build completed successfully on Fedora!"

#==============================================
# RootFS Preparation Stage (Root privileges)
#==============================================
FROM fedora:40 AS rootfs-preparer

ARG FEX_VERSION
ARG ROOTFS_OS=fedora
ARG ROOTFS_VERSION="40"
ARG ROOTFS_TYPE=squashfs
ARG ROOTFS_URL=""

LABEL fex.version="${FEX_VERSION}"
LABEL fex.rootfs.os="${ROOTFS_OS}"
LABEL fex.rootfs.version="${ROOTFS_VERSION}"
LABEL fex.rootfs.type="shared"

ENV TZ=Asia/Seoul

# Install RootFS extraction tools and dependencies for Fedora
RUN --mount=type=cache,target=/var/cache/dnf,sharing=locked \
    echo "ğŸ“¦ Installing RootFS extraction tools and dependencies..." && \
    echo "ğŸ§ Using Fedora for RootFS preparation" && \
    echo "ğŸ”§ Setting up extraction toolchain..." && \
    dnf update -y -q && \
    dnf install -y -q \
        curl \
        sudo \
        coreutils \
        squashfs-tools \
        erofs-utils \
        e2fsprogs \
        util-linux \
        ca-certificates \
        >/dev/null 2>&1 && \
    update-ca-trust && \
    echo "âœ… CA certificates updated"

# Create shared RootFS directory (as root)
RUN echo "ğŸ“ Creating shared RootFS directory structure..." && \
    mkdir -p /opt/fex-rootfs && \
    chmod 755 /opt/fex-rootfs && \
    echo "âœ… RootFS directory created: /opt/fex-rootfs"

# Copy FEX binaries from Fedora builder
COPY --from=fex-builder /usr/local/fex /usr/local/fex
RUN echo "ğŸ“¦ Copying FEX binaries from Fedora builder..." && \
    echo "âœ… FEX binaries copied successfully" && \
    echo "ğŸ“Š FEX installation summary:" && \
    ls -la /usr/local/fex/bin/ && \
    echo "ğŸ”§ Optimizing FEX binaries for production..." && \
    strip /usr/local/fex/bin/* 2>/dev/null || true && \
    find /usr/local/fex -name "*.so*" -exec strip --strip-unneeded {} + 2>/dev/null || true && \
    echo "âœ… FEX binary optimization completed" && \
    echo "ğŸ‰ Fedora-built FEX ready for RootFS operations!"

ENV PATH="/usr/local/fex/bin:$PATH"

# Create temporary fex user for FEXRootFSFetcher (but stay as root)
RUN echo "ğŸ‘¤ Creating temporary fex user for RootFS operations..." && \
    useradd -m -s /bin/bash fex && \
    usermod -aG wheel fex && \
    echo "fex ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers && \
    echo "âœ… fex user created with sudo privileges"

# RootFS setup (as root with privilege escalation capabilities)
RUN --mount=type=cache,target=/var/cache/dnf,sharing=locked \
    echo "ğŸš€ Starting RootFS setup process as root..." && \
    echo "ğŸ“Š RootFS configuration summary:" && \
    echo "  - Target OS: ${ROOTFS_OS}" && \
    echo "  - Target Version: ${ROOTFS_VERSION}" && \
    echo "  - RootFS Type: ${ROOTFS_TYPE}" && \
    echo "  - RootFS URL: ${ROOTFS_URL}" && \
    echo "  - Strategy: FEXRootFSFetcher + Manual fallback to shared directory" && \
    echo "  - Location: /opt/fex-rootfs/" && \
    echo "  - Running as: root (for proper permissions)" && \
    \
    # Prepare fex user home for RootFS operations
    mkdir -p /home/fex/.fex-emu/RootFS && \
    chown -R fex:fex /home/fex && \
    \
    # ğŸ”§ Define dynamic paths based on execution user
    FEX_USER="fex" && \
    FEX_USER_HOME="/home/$FEX_USER" && \
    FEX_ROOTFS_DIR="$FEX_USER_HOME/.fex-emu/RootFS" && \
    FEX_CONFIG_PATH="$FEX_USER_HOME/.fex-emu/Config.json" && \
    echo "ğŸ“ Dynamic paths configured:" && \
    echo "  - FEX User: $FEX_USER" && \
    echo "  - FEX User Home: $FEX_USER_HOME" && \
    echo "  - FEX RootFS Directory: $FEX_ROOTFS_DIR" && \
    echo "  - FEX Config Path: $FEX_CONFIG_PATH" && \
    \
    # Try FEXRootFSFetcher first (as fex user but with root oversight)
    FEXROOTFS_SUCCESS=false && \
    echo "ğŸ¯ Attempting FEXRootFSFetcher (primary method)..." && \
    for attempt in 1 2 3; do \
        echo "â³ FEXRootFSFetcher attempt $attempt/3..." && \
        if sudo -u $FEX_USER timeout 300 bash -c "cd $FEX_USER_HOME && FEXRootFSFetcher -yx --distro-name=${ROOTFS_OS} --distro-version=${ROOTFS_VERSION} --force-ui=tty" 2>/dev/null; then \
            echo "âœ… FEXRootFSFetcher completed successfully (attempt $attempt)" && \
            FEXROOTFS_SUCCESS=true && \
            break; \
        else \
            echo "âŒ FEXRootFSFetcher failed (attempt $attempt)" && \
            if [ $attempt -lt 3 ]; then \
                echo "â³ Waiting 5 seconds before retry..." && \
                sleep 5; \
            fi; \
        fi; \
    done && \
    \
    # Fallback to manual setup with dynamic paths
    if [ "$FEXROOTFS_SUCCESS" = "false" ]; then \
        echo "ğŸ”„ FEXRootFSFetcher failed - activating manual setup fallback..." && \
        echo "ğŸ“¥ Switching to direct URL download method..." && \
        \
        mkdir -p /tmp/fex-rootfs && \
        \
        if [ -z "$ROOTFS_URL" ]; then \
            echo "âŒ ROOTFS_URL is not provided for manual download" && \
            exit 1; \
        fi && \
        \
        echo "ğŸ“¥ Downloading RootFS from official URL: $ROOTFS_URL" && \
            ROOTFS_FILE=$(basename "$ROOTFS_URL") && \
            ROOTFS_LOCAL_PATH="/tmp/fex-rootfs/$ROOTFS_FILE" && \
        \
        # ğŸ”§ Fixed curl command (remove syntax errors)
        DOWNLOAD_SUCCESS=false && \
        echo "ğŸ” Starting download with corrected curl command..." && \
        for download_attempt in 1 2 3; do \
            echo "â³ Download attempt $download_attempt/3..." && \
            if curl -L -k -S -H 'Cache-Control: no-cache' \
                    --connect-timeout 30 --max-time 600 \
                    --retry 3 --retry-delay 5 \
                    -o "$ROOTFS_LOCAL_PATH" \
                    "$ROOTFS_URL"; then \
                # Verify downloaded file exists and has content
                if [ -f "$ROOTFS_LOCAL_PATH" ] && [ -s "$ROOTFS_LOCAL_PATH" ]; then \
                    echo "âœ… RootFS downloaded successfully (attempt $download_attempt)" && \
                    echo "ğŸ“Š File verification: $(ls -lh "$ROOTFS_LOCAL_PATH")" && \
                    DOWNLOAD_SUCCESS=true && \
                    break; \
                else \
                    echo "âŒ Downloaded file is missing or empty" && \
                    rm -f "$ROOTFS_LOCAL_PATH"; \
                fi; \
            else \
                echo "âŒ Download failed (attempt $download_attempt)"; \
            fi && \
            if [ $download_attempt -lt 3 ]; then \
                echo "â³ Waiting 10 seconds before retry..." && \
                sleep 10; \
            fi; \
        done && \
        \
        if [ "$DOWNLOAD_SUCCESS" = "false" ]; then \
            echo "âŒ Failed to download RootFS after 3 attempts" && \
            exit 1; \
        fi && \
        \
        echo "âœ… Found RootFS file: $ROOTFS_FILE" && \
        echo "ğŸ“Š File size: $(du -h "$ROOTFS_LOCAL_PATH" | cut -f1)" && \
        \
        # ğŸ”§ Use dynamic paths instead of hardcoded ones
        ROOTFS_DIRNAME="$(echo ${ROOTFS_OS} | sed 's/^./\U&/')_$(echo ${ROOTFS_VERSION} | sed 's/\./_/g')" && \
        EXTRACT_DIR="$FEX_ROOTFS_DIR/${ROOTFS_DIRNAME}" && \
        echo "ğŸ“ RootFS directory name: $ROOTFS_DIRNAME" && \
        echo "ğŸ“ Dynamic extraction directory: $EXTRACT_DIR" && \
        \
        if [ -d "$EXTRACT_DIR" ]; then \
            echo "ğŸ—‘ï¸ Removing existing RootFS directory..." && \
            rm -rf "$EXTRACT_DIR"; \
        fi && \
        mkdir -p "$EXTRACT_DIR" && \
        echo "ğŸ“ Created extraction directory: $EXTRACT_DIR" && \
        \
        if echo "$ROOTFS_FILE" | grep -q '\.sqsh$\|\.squashfs$'; then \
            echo "ğŸ”§ Extracting SquashFS file using unsquashfs..." && \
            if command -v unsquashfs >/dev/null 2>&1; then \
                unsquashfs -f -d "$EXTRACT_DIR" "$ROOTFS_LOCAL_PATH" >/dev/null 2>&1 && \
                echo "âœ… SquashFS extraction completed successfully"; \
            else \
                echo "ğŸ“¦ unsquashfs not found. Installing squashfs-tools..." && \
                dnf update -y && dnf install -y squashfs-tools && \
                unsquashfs -f -d "$EXTRACT_DIR" "$ROOTFS_LOCAL_PATH" && \
                echo "âœ… SquashFS extraction completed with tools installation"; \
            fi; \
        elif echo "$ROOTFS_FILE" | grep -q '\.ero$\|\.erofs$'; then \
            echo "ğŸ”§ Extracting EROFS file..." && \
            if ! command -v dump.erofs >/dev/null 2>&1; then \
                echo "ğŸ“¦ Installing erofs-utils..." && \
                dnf update -y && dnf install -y erofs-utils; \
            fi && \
            dump.erofs --extract="$EXTRACT_DIR" "$ROOTFS_LOCAL_PATH" >/dev/null 2>&1 && \
            echo "âœ… EROFS extraction completed successfully"; \
        else \
            echo "âŒ Unknown RootFS file format: $ROOTFS_FILE" && \
            exit 1; \
        fi && \
        \
        echo "âš™ï¸ Writing FEX configuration..." && \
        printf '{"Config":{"RootFS":"%s"},"ThunksDB":{}}' "$ROOTFS_DIRNAME" > "$FEX_CONFIG_PATH" && \
        echo "âœ… FEX configuration written to $FEX_CONFIG_PATH" && \
        \
        chown -R $FEX_USER:$FEX_USER $FEX_USER_HOME/.fex-emu && \
        \
        echo "ğŸ” Verifying manual RootFS installation..." && \
        if [ -d "$EXTRACT_DIR" ]; then \
            ROOTFS_CONTENT_COUNT=$(find "$EXTRACT_DIR" -type f | wc -l) && \
            echo "ğŸ“Š Manual RootFS verification results:" && \
            echo "  - Directory: $EXTRACT_DIR" && \
            echo "  - Files: $ROOTFS_CONTENT_COUNT" && \
            if [ "$ROOTFS_CONTENT_COUNT" -gt 100 ]; then \
                echo "âœ… Manual RootFS appears to be properly extracted"; \
            else \
                echo "âš ï¸ Manual RootFS may be incomplete (too few files)"; \
            fi; \
        else \
            echo "âŒ Manual RootFS directory not found after extraction" && \
            exit 1; \
        fi && \
        \
        echo "ğŸ‰ Manual RootFS setup completed successfully as fallback!"; \
    else \
        echo "ğŸ‰ FEXRootFSFetcher setup completed successfully!" && \
        chown -R $FEX_USER:$FEX_USER $FEX_USER_HOME/.fex-emu; \
    fi && \
    \
    # ğŸ”§ Move user-specific RootFS to shared directory using dynamic paths
    echo "ğŸ“ Moving RootFS to shared directory: /opt/fex-rootfs/..." && \
    echo "ğŸ” Checking source directory: $FEX_ROOTFS_DIR" && \
    if [ -d "$FEX_ROOTFS_DIR" ] && [ "$(ls -A "$FEX_ROOTFS_DIR" 2>/dev/null)" ]; then \
        echo "ğŸ“Š Source directory contents: $(ls -la "$FEX_ROOTFS_DIR/")" && \
        cp -r "$FEX_ROOTFS_DIR"/* /opt/fex-rootfs/ && \
        chown -R root:root /opt/fex-rootfs && \
        chmod -R 755 /opt/fex-rootfs && \
        echo "âœ… RootFS successfully moved to shared directory"; \
    else \
        echo "âŒ No RootFS found to move to shared directory" && \
        echo "ğŸ” Debug: Checking alternative locations..." && \
        find /home -name "*.sqsh" -o -name "Fedora_*" -type d 2>/dev/null || true && \
        find /root -name "*.sqsh" -o -name "Fedora_*" -type d 2>/dev/null || true && \
        exit 1; \
    fi && \
    \
    # Final verification with improved debugging
    echo "ğŸ” Final RootFS verification and summary..." && \
    if [ -d "/opt/fex-rootfs" ]; then \
        ROOTFS_COUNT=$(find /opt/fex-rootfs -maxdepth 1 -type d | wc -l) && \
        ROOTFS_FILES=$(find /opt/fex-rootfs -type f | wc -l) && \
        echo "ğŸ‰ RootFS setup completed successfully!" && \
        echo "ğŸ“Š Final RootFS verification summary:" && \
        echo "  - RootFS directories: $ROOTFS_COUNT" && \
        echo "  - RootFS files: $ROOTFS_FILES" && \
        echo "  - Method used: $( [ "$FEXROOTFS_SUCCESS" = "true" ] && echo "FEXRootFSFetcher (primary)" || echo "Manual setup (fallback)" )" && \
        echo "  - RootFS size: $(du -sh /opt/fex-rootfs 2>/dev/null || echo 'Unknown')" && \
        echo "  - Location: /opt/fex-rootfs/" && \
        echo "  - Contents: $(ls -la /opt/fex-rootfs/ 2>/dev/null || echo 'Directory empty or not accessible')" && \
        if [ "$ROOTFS_FILES" -gt 0 ]; then \
            echo "âœ… Final RootFS verification passed successfully"; \
        else \
            echo "âŒ Final RootFS verification failed - no files found" && \
            exit 1; \
        fi; \
    else \
        echo "âŒ RootFS directory not found" && \
        exit 1; \
    fi && \
    \
    # Cleanup (as root - no permission issues)
    echo "ğŸ§¹ Cleaning up temporary RootFS artifacts..." && \
    rm -rf /tmp/fex-rootfs && \
    find /opt/fex-rootfs -name "*.sqsh" -delete 2>/dev/null || true && \
    find /opt/fex-rootfs -name "*.ero" -delete 2>/dev/null || true && \
    dnf clean all -q && \
    echo "âœ… Cleanup completed successfully" && \
    echo "ğŸš€ Ready for immediate x86 application execution with RootFS!" && \
    echo "ğŸ¯ RootFS preparation stage complete!" && \
    \
    # ğŸ”§ Set FEX_ROOTFS_PATH environment variable for runtime
    echo "ğŸ”§ Setting FEX_ROOTFS_PATH environment variable..." && \
    echo "export FEX_ROOTFS_PATH=/opt/fex-rootfs" >> /etc/environment && \
    echo "âœ… FEX_ROOTFS_PATH environment variable set" && \
    \
    # ğŸ”§ Create a symbolic link to the RootFS in the default FEX location
    echo "ğŸ”— Creating symbolic link to RootFS in default FEX location..." && \
    FEX_USER_HOME="/home/fex" && \
    FEX_ROOTFS_DIR="$FEX_USER_HOME/.fex-emu/RootFS" && \
    mkdir -p "$FEX_ROOTFS_DIR" && \
    # Find the actual RootFS directory name (e.g., Fedora_40)
    ACTUAL_ROOTFS_DIR=$(ls -1 /opt/fex-rootfs | head -n 1) && \
    if [ -n "$ACTUAL_ROOTFS_DIR" ]; then \
        ln -s "/opt/fex-rootfs/$ACTUAL_ROOTFS_DIR" "$FEX_ROOTFS_DIR/$ACTUAL_ROOTFS_DIR" && \
        echo "âœ… Symbolic link created: $FEX_ROOTFS_DIR/$ACTUAL_ROOTFS_DIR -> /opt/fex-rootfs/$ACTUAL_ROOTFS_DIR"; \
    else \
        echo "âŒ No RootFS directory found in /opt/fex-rootfs to create symbolic link" && \
        exit 1; \
    fi && \
    \
    # ğŸ”§ Write FEX configuration file to point to the shared RootFS
    echo "âš™ï¸ Writing FEX configuration file to point to shared RootFS..." && \
    FEX_CONFIG_PATH="$FEX_USER_HOME/.fex-emu/Config.json" && \
    mkdir -p "$(dirname "$FEX_CONFIG_PATH")" && \
    printf '{"Config":{"RootFS":"/opt/fex-rootfs/%s"},"ThunksDB":{}}' "$ACTUAL_ROOTFS_DIR" > "$FEX_CONFIG_PATH" && \
    chown -R $FEX_USER:$FEX_USER "$FEX_USER_HOME/.fex-emu" && \
    echo "âœ… FEX configuration file written to $FEX_CONFIG_PATH" && \
    echo "ğŸ¯ FEX configuration updated to use shared RootFS!"

#==============================================
# Runtime Stage with Fedora Base
#==============================================
FROM fedora:40 AS runtime

ARG FEX_VERSION
ARG TARGETPLATFORM 
ARG ROOTFS_OS=fedora
ARG ROOTFS_VERSION="40"
ARG ROOTFS_TYPE=squashfs

# RootFS related metadata
LABEL org.opencontainers.image.title="FEXBash Fedora-Optimized ARM64 Container with RootFS"
LABEL org.opencontainers.image.description="High-performance x86/x86_64 emulation on ARM64 with Fedora base and shared RootFS"
LABEL org.opencontainers.image.version="${FEX_VERSION}"
LABEL fex.version="${FEX_VERSION}"
LABEL fex.rootfs.distribution="${ROOTFS_OS}-${ROOTFS_VERSION}"
LABEL fex.rootfs.type="shared"
LABEL fex.rootfs.location="/opt/fex-rootfs"
LABEL build.platform="${TARGETPLATFORM}"
LABEL base.image="fedora:40"

# Set environment variables for Fedora runtime
ENV TZ=Asia/Seoul
ENV FEX_VERSION=${FEX_VERSION}
ENV ROOTFS_INFO="${ROOTFS_OS}-${ROOTFS_VERSION}"
ENV FEX_SHARED_ROOTFS="/opt/fex-rootfs"

# Configure Fedora runtime environment
RUN echo "ğŸ—ï¸ Setting up Fedora 40 runtime environment with RootFS..." && \
    echo "ğŸ“Š Fedora runtime configuration:" && \
    echo "  - Base: Fedora 40" && \
    echo "  - Target: High-performance x86 emulation runtime" && \
    echo "  - Features: Native glibc + Fedora stability + RootFS" && \
    echo "  - RootFS: /opt/fex-rootfs" && \
    ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && \
    echo $TZ > /etc/timezone && \
    echo "âœ… Fedora runtime environment configured"

# Install minimal Fedora runtime dependencies 
RUN --mount=type=cache,target=/var/cache/dnf,sharing=locked \
    echo "ğŸ“¦ Installing minimal Fedora runtime packages..." && \
    echo "ğŸ” Selecting only essential runtime components..." && \
    echo "ğŸ“Š Runtime build parameters:" && \
    echo "  - ROOTFS_OS: ${ROOTFS_OS}" && \
    echo "  - ROOTFS_VERSION: ${ROOTFS_VERSION}" && \
    echo "  - ROOTFS_TYPE: ${ROOTFS_TYPE}" && \
    echo "  - RootFS: /opt/fex-rootfs" && \
    dnf update -y -q && \
    echo "ğŸ“¦ Installing minimal runtime packages..." && \
    dnf install -y -q \
        sudo curl wget jq \
        glibc \
        libstdc++ \
        openssl-libs \
        zstd-libs \
        squashfs-tools \
        erofs-utils \
        binfmt-support \
        ca-certificates \
        >/dev/null 2>&1 && \
    update-ca-trust && \
    echo "âœ… Fedora runtime packages installed successfully" && \
    echo "ğŸ“Š Runtime package summary:" && \
    echo "  - System libraries: libstdc++, glibc" && \
    echo "  - Utilities: sudo, curl, wget, jq, file" && \
    echo "  - Architecture: ARM64 with x86 emulation support" && \
    echo "  - RootFS: Enabled" && \
    \
    # Fedora cleanup for size optimization
    echo "ğŸ§¹ Performing Fedora cleanup for size optimization..." && \ 
    dnf clean all -q && \
    rm -rf /var/tmp/* && \
    echo "âœ… Fedora runtime setup completed successfully" && \
    echo "ğŸ‰ Fedora runtime environment ready!"

# Copy optimized FEX binaries from Fedora builder
COPY --from=fex-builder /usr/local/fex /usr/local/fex
RUN echo "ğŸ“¦ Copying FEX binaries to Fedora runtime..." && \
    echo "âœ… FEX binaries copied to Fedora runtime successfully" && \
    echo "ğŸ“Š FEX installation summary:" && \
    ls -la /usr/local/fex/bin/ && \
    echo "ğŸ”§ Final FEX binary optimization for Fedora..." && \
    strip /usr/local/fex/bin/* 2>/dev/null || true && \
    find /usr/local/fex -name "*.so*" -exec strip --strip-unneeded {} + 2>/dev/null || true && \
    echo "âœ… FEX binary optimization completed for Fedora runtime" && \
    echo "ğŸš€ Fedora-optimized FEX ready!"

ENV PATH="/usr/local/fex/bin:$PATH"

# Copy RootFS and configuration (as root)
COPY --from=rootfs-preparer /opt/fex-rootfs /opt/fex-rootfs

# Set up RootFS configuration (as root - no permission issues)
RUN echo "ğŸ“¦ Installing RootFS in Fedora runtime..." && \
    chown -R root:root /opt/fex-rootfs && \
    chmod -R 755 /opt/fex-rootfs && \
    echo "âœ… RootFS ownership configured for Fedora" && \
    \
    echo "ğŸ“‹ Creating template configuration for new users..." && \
    mkdir -p /etc/skel/.fex-emu && \
    ROOTFS_DIRNAME=$(ls /opt/fex-rootfs/ | head -1) && \
    echo "ğŸ“ Detected RootFS directory: $ROOTFS_DIRNAME" && \
    if [ -n "$ROOTFS_DIRNAME" ]; then \
        echo "{\"Config\":{\"RootFS\":\"/opt/fex-rootfs/$ROOTFS_DIRNAME\"}}" > /etc/skel/.fex-emu/Config.json && \
        echo "âœ… Template configuration created for new users: /opt/fex-rootfs/$ROOTFS_DIRNAME"; \
    else \
        echo "âŒ No RootFS directory found in shared location" && \
        exit 1; \
    fi && \
    \
    echo "ğŸ‰ RootFS pre-installed in Fedora image!" && \
    echo "ğŸ“Š RootFS verification:" && \
    echo "  - RootFS directory: /opt/fex-rootfs/$ROOTFS_DIRNAME" && \
    echo "  - RootFS files: $(find /opt/fex-rootfs -type f | wc -l)" && \
    echo "  - RootFS size: $(du -sh /opt/fex-rootfs)" && \
    echo "  - Template config: /etc/skel/.fex-emu/Config.json" && \
    echo "ğŸ¯ Fedora + FEX + RootFS integration complete!" && \
    echo "ğŸš€ Ready for immediate x86 application execution on Fedora!" && \
    echo "ğŸ—ï¸ Fedora stability achieved: Fedora + RootFS + FEX emulation!" && \
    echo "ğŸ¯ New users will automatically use RootFS!"

# Create default fex user (finally, as the last step)
RUN echo "ğŸ‘¤ Creating default fex user for Fedora runtime..." && \
    echo "ğŸ”§ Configuring Fedora user management..." && \
    useradd -m -s /bin/bash fex && \
    usermod -aG wheel fex && \
    echo "fex ALL=(ALL) NOPASSWD: ALL" > /etc/sudoers.d/fex && \
    echo "âœ… Fedora user configuration completed successfully" && \
    echo "ğŸ¯ User 'fex' ready for x86 emulation with RootFS!"

# Switch to fex user (final step)
USER fex
WORKDIR /home/fex 

# Verify RootFS configuration status for fex user
RUN echo "ğŸ” Verifying RootFS configuration for user..." && \
    if [ -f "/home/fex/.fex-emu/Config.json" ]; then \
        echo "âœ… User configuration found: $(cat /home/fex/.fex-emu/Config.json)"; \
    else \
        echo "âŒ User configuration not found" && \
        exit 1; \
    fi && \
    if [ -d "/opt/fex-rootfs" ]; then \
        echo "âœ… RootFS directory accessible: $(ls -la /opt/fex-rootfs/ | head -3)"; \
    else \
        echo "âŒ RootFS directory not accessible" && \
        exit 1; \
    fi && \
    echo "ğŸ‰ RootFS verification completed successfully!"

# Fedora-optimized startup command with RootFS information
CMD ["/bin/bash", "-c", "echo 'ğŸ‰ FEX-Emu on Fedora with RootFS ready!' && echo 'ğŸ—ï¸ Base: Fedora 40 (Cutting-edge stability)' && echo 'ğŸ·ï¸ FEX Version: ${FEX_VERSION}' && echo 'ğŸ§ RootFS: ${ROOTFS_INFO} (Shared)' && echo 'ğŸ“ RootFS Location: /opt/fex-rootfs' && echo 'ğŸ”§ Fedora for cutting-edge compatibility and rolling release benefits!' && echo 'ğŸ“Š Native glibc: Perfect x86 emulation support' && echo 'ğŸš€ Performance: Near-native ARM64 execution with x86 emulation' && echo 'ğŸ‘¥ Multi-user: All users share the same RootFS' && echo 'ğŸ’¡ Try: FEXBash' && echo 'ğŸ¯ Ready for x86 application execution!' && /bin/bash"]