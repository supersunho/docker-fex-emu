name: FEXBash Builder

on:
    # Daily automatic builds (Latest candidates only)
    schedule:
        - cron: "0 0 * * *"

    # Manual trigger (Selective builds)
    workflow_dispatch:
        inputs:
            runner:
                description: "Choose runner type"
                type: choice
                default: "ubuntu-24.04-arm"
                options:
                    - "ubuntu-24.04"
                    - "ubuntu-22.04"
                    - "ubuntu-24.04-arm"
                    - "ubuntu-22.04-arm"
                    - "ubuntu-latest"
                    - "self-hosted-arm64"

            build_scope:
                description: "Build scope selection"
                required: true
                default: "latest-only"
                type: choice
                options:
                    - "latest-only"
                    - "ubuntu-all"
                    - "fedora-all"
                    - "full-matrix"
                    - "custom"
            custom_dockerfile:
                description: "Custom dockerfile"
                required: false
                default: "Dockerfile"
                type: string
            custom_distros:
                description: "Custom distributions (comma-separated)"
                required: false
                default: ""
                type: string

            version:
                description: "FEX version (e.g., FEX-2505, FEX-2506, latest for newest)"
                required: false
                default: "latest"
                type: string

            verify_build:
                description: "Verify build"
                required: false
                default: false
                type: boolean

            force_rebuild:
                description: "Force rebuild even if image exists"
                required: false
                default: false
                type: boolean

            clear_cache:
                description: "Clear build cache before building"
                required: false
                default: false
                type: boolean

# Optimized concurrency management with version isolation
concurrency:
    group: ${{ github.workflow }}-${{ github.event_name }}-${{ github.ref }}-${{ github.event.inputs.build_scope || 'latest-only' }}-${{ github.event.inputs.version || 'latest' }}
    cancel-in-progress: true

# Enhanced global environment variables
env:
    REGISTRY: ghcr.io
    IMAGE_NAME: ${{ github.repository }}/${{ github.event.repository.name }}
    LLVM_VERSION: "18"
    DOCKER_BUILDKIT: 1
    BUILDKIT_PROGRESS: plain
    CACHE_VERSION: v3
    DOCKERHUB_REPO: supersunho/fex-emu

# Default permissions (least privilege)
permissions:
    contents: read

jobs:
    # Combined job for better efficiency
    prepare-and-generate:
        runs-on: ${{ github.event.inputs.runner == 'self-hosted-arm64' && fromJSON('["self-hosted", "linux", "arm64"]') || github.event.inputs.runner }}
        outputs:
            # EOL outputs
            ubuntu-eol-versions: ${{ steps.get-eol.outputs.ubuntu-eol-versions }}
            fedora-eol-versions: ${{ steps.get-eol.outputs.fedora-eol-versions }}
            # Matrix outputs
            filtered-matrix: ${{ steps.filter-matrix.outputs.filtered-matrix }}
            has-builds: ${{ steps.filter-matrix.outputs.has-builds }}
            # Version outputs
            version: ${{ steps.get-version.outputs.version }}
            version_clean: ${{ steps.get-version.outputs.version_clean }}
            fex_semantic: ${{ steps.get-version.outputs.fex_semantic }}
        steps:
            - name: Get EOL information
              id: get-eol
              run: |
                  echo "üîç Fetching Ubuntu and Fedora EOL information..."
                  CURRENT_DATE=$(date +%Y-%m-%d)

                  # Ubuntu EOL processing
                  ALL_UBUNTU=$(curl -s https://endoflife.date/api/ubuntu.json | jq -r '.[].cycle')
                  SUPPORTED_UBUNTU=$(curl -s https://endoflife.date/api/ubuntu.json | \
                      jq -r --arg current_date "$CURRENT_DATE" '
                      .[] | 
                      select(
                          (.eol | type == "string" and . >= $current_date) or
                          ((.extendedSupport | type == "string") and .extendedSupport >= $current_date)
                      ) | 
                      .cycle')

                  UBUNTU_EOL_LIST=""
                  for version in $ALL_UBUNTU; do
                      if ! echo "$SUPPORTED_UBUNTU" | grep -q "^${version}$"; then
                          UBUNTU_EOL_LIST="${UBUNTU_EOL_LIST:+$UBUNTU_EOL_LIST|}$version"
                      fi
                  done

                  # Force add Ubuntu 20.04 (compatibility issues with FEX)
                  if ! echo "|$UBUNTU_EOL_LIST|" | grep -q "|20.04|"; then
                      UBUNTU_EOL_LIST="20.04${UBUNTU_EOL_LIST:+|$UBUNTU_EOL_LIST}"
                  fi

                  # Fedora EOL processing with 2-year support window
                  ALL_FEDORA=$(curl -s https://endoflife.date/api/fedora.json | jq -r '.[].cycle')
                  SUPPORTED_FEDORA=$(curl -s https://endoflife.date/api/fedora.json | \
                      jq -r --arg current_date "$CURRENT_DATE" '
                      .[] | 
                      select(
                          (.eol | type == "string") and 
                          ((.eol | strptime("%Y-%m-%d") | mktime) > (($current_date | strptime("%Y-%m-%d") | mktime) - (730 * 24 * 3600)))
                      ) | 
                      .cycle')

                  FEDORA_EOL_LIST=""
                  for version in $ALL_FEDORA; do
                      if ! echo "$SUPPORTED_FEDORA" | grep -q "^${version}$"; then
                          FEDORA_EOL_LIST="${FEDORA_EOL_LIST:+$FEDORA_EOL_LIST|}$version"
                      fi
                  done

                  # Fallback EOL lists for offline scenarios
                  UBUNTU_EOL_LIST="${UBUNTU_EOL_LIST:-20.04|23.10|23.04|22.10|21.10|21.04|20.10|19.10|19.04|18.10|17.10|17.04|16.10|15.10|15.04|14.10|13.10|13.04|12.10|11.10|11.04|10.10|9.10|9.04|8.10|7.10|7.04|6.10|5.10|5.04|4.10}"
                  FEDORA_EOL_LIST="${FEDORA_EOL_LIST:-38|37|36|35|34|33|32|31|30|29|28|27|26|25|24|23|22|21|20|19|18|17|16|15|14|13|12|11|10|9|8|7|6|5|4|3|2|1}"

                  echo "ubuntu-eol-versions=$UBUNTU_EOL_LIST" >> $GITHUB_OUTPUT
                  echo "fedora-eol-versions=$FEDORA_EOL_LIST" >> $GITHUB_OUTPUT

            - name: Get target version with semantic parsing
              id: get-version
              run: |
                  if [ "${{ github.event.inputs.version }}" = "latest" ] || [ "${{ github.event.inputs.version }}" = "" ]; then
                    echo "üîç Fetching latest FEX release information..."
                    RELEASE_DATA=$(curl -s https://api.github.com/repos/FEX-Emu/FEX/releases/latest)
                    VERSION=$(echo "$RELEASE_DATA" | jq -r .tag_name)
                    RELEASE_NOTES=$(echo "$RELEASE_DATA" | jq -r .body | head -c 500)
                  else
                    VERSION="${{ github.event.inputs.version }}"
                    RELEASE_NOTES="Custom build for FEX version $VERSION"
                  fi

                  VERSION_CLEAN=${VERSION#v}
                  # Convert FEX-YYMM format to semantic version
                  if [[ $VERSION_CLEAN =~ ^FEX-([0-9]{2})([0-9]{2})$ ]]; then
                    FEX_SEMANTIC="${BASH_REMATCH[1]}${BASH_REMATCH[2]}"
                  else
                    FEX_SEMANTIC="$VERSION_CLEAN"
                  fi

                  echo "version=$VERSION" >> $GITHUB_OUTPUT
                  echo "version_clean=$VERSION_CLEAN" >> $GITHUB_OUTPUT
                  echo "fex_semantic=$FEX_SEMANTIC" >> $GITHUB_OUTPUT
                  echo "release_notes<<EOF" >> $GITHUB_OUTPUT
                  echo "$RELEASE_NOTES" >> $GITHUB_OUTPUT
                  echo "EOF" >> $GITHUB_OUTPUT

                  echo "üìã Target version: $VERSION (Semantic: $FEX_SEMANTIC)"

            - name: Generate and filter distribution matrix with Ubuntu base
              id: filter-matrix
              run: |
                  echo "üîç Generating distribution matrix from FEX RootFS API with Ubuntu 24.04 base..."

                  # Download RootFS data with enhanced error handling and fallback
                  if curl -s --connect-timeout 30 --max-time 60 https://rootfs.fex-emu.gg/RootFS_links.json -o /tmp/RootFS_links.json; then
                      ROOTFS_DATA=$(cat /tmp/RootFS_links.json)
                      echo "‚úÖ Successfully fetched RootFS data from API"
                  else
                      echo "‚ö†Ô∏è API unavailable, using embedded fallback data"
                      ROOTFS_DATA='{"v1":{"Ubuntu 24.04 (SquashFS)":{"DistroMatch":"ubuntu","DistroVersion":"24.04","URL":"https://rootfs.fex-emu.gg/Ubuntu_24_04/2025-03-04/Ubuntu_24_04.sqsh","Hash":"6d469a5d2bb838ac","Type":"squashfs"},"Ubuntu 22.04 (SquashFS)":{"DistroMatch":"ubuntu","DistroVersion":"22.04","URL":"https://rootfs.fex-emu.gg/Ubuntu_22_04/2024-11-15/Ubuntu_22_04.sqsh","Hash":"8f3a2b5c9d7e1f4a","Type":"squashfs"},"Fedora 40 (SquashFS)":{"DistroMatch":"fedora","DistroVersion":"40","URL":"https://rootfs.fex-emu.gg/Fedora_40/2025-01-08/Fedora_40.sqsh","Hash":"fb51fcd7f086fa19","Type":"squashfs"}}}'
                  fi

                  BUILD_SCOPE="${{ github.event.inputs.build_scope || 'latest-only' }}"
                  echo "üéØ Selected build scope: $BUILD_SCOPE"
                  echo "üèóÔ∏è Using Ubuntu 24.04 as universal base image for all RootFS distributions"

                  # Generate matrix based on build scope with Ubuntu 24.04 base image
                  case "$BUILD_SCOPE" in
                      "latest-only")
                      echo "üì¶ Building latest candidate distributions with Ubuntu 24.04 base"
                      MATRIX=$(echo "$ROOTFS_DATA" | jq -c '
                          {
                          "include": [
                              (.v1 | to_entries | map(select(.value.DistroMatch == "ubuntu" and .value.Type == "squashfs")) | sort_by(.value.DistroVersion | split(".") | map(tonumber)) | last | .value),
                              (.v1 | to_entries | map(select(.value.DistroMatch == "fedora" and .value.Type == "squashfs")) | sort_by(.value.DistroVersion | tonumber) | last | .value)
                          ] | map({
                              "ROOTFS_OS": .DistroMatch,
                              "ROOTFS_VERSION": .DistroVersion,
                              "ROOTFS_URL": .URL,
                              "ROOTFS_TYPE": .Type,
                              "ROOTFS_HASH": .Hash,
                              "BASE_IMAGE": "ubuntu:24.04",
                              "TAG_VERSION": (
                              if .DistroMatch == "ubuntu" then (.DistroVersion | gsub("\\."; ""))
                              elif .DistroMatch == "fedora" then "f" + .DistroVersion
                              else "unknown"
                              end
                              )
                          })
                          }
                      ')
                      ;;
                      
                      "ubuntu-all")
                      echo "üêß Building all supported Ubuntu versions with Ubuntu 24.04 base"
                      MATRIX=$(echo "$ROOTFS_DATA" | jq -c '
                          {
                          "include": [
                              .v1 | to_entries[] | 
                              select(.value.DistroMatch == "ubuntu" and .value.Type == "squashfs") |
                              .value |
                              {
                              "ROOTFS_OS": .DistroMatch,
                              "ROOTFS_VERSION": .DistroVersion,
                              "ROOTFS_TYPE": .Type,
                              "ROOTFS_URL": .URL,
                              "ROOTFS_HASH": .Hash,
                              "BASE_IMAGE": "ubuntu:24.04",
                              "TAG_VERSION": (.DistroVersion | gsub("\\."; ""))
                              }
                          ]
                          }
                      ')
                      ;;

                      "fedora-all")
                      echo "üé© Building all supported Fedora versions with Ubuntu 24.04 base"
                      MATRIX=$(echo "$ROOTFS_DATA" | jq -c '
                          {
                          "include": [
                              .v1 | to_entries[] | 
                              select(.value.DistroMatch == "fedora" and .value.Type == "squashfs") |
                              .value |
                              {
                              "ROOTFS_OS": .DistroMatch,
                              "ROOTFS_VERSION": .DistroVersion,
                              "ROOTFS_TYPE": .Type,
                              "ROOTFS_URL": .URL,
                              "ROOTFS_HASH": .Hash,
                              "BASE_IMAGE": "ubuntu:24.04",
                              "TAG_VERSION": ("f" + .DistroVersion)
                              }
                          ]
                          }
                      ')
                      ;;
                      
                      "full-matrix")
                      echo "üåç Building complete distribution matrix with Ubuntu 24.04 base"
                      MATRIX=$(echo "$ROOTFS_DATA" | jq -c '
                          {
                          "include": [
                              .v1 | to_entries[] | 
                              select(.value.Type == "squashfs") |
                              select(.value.DistroMatch == "ubuntu" or .value.DistroMatch == "fedora") |
                              .value |
                              {
                              "ROOTFS_OS": .DistroMatch,
                              "ROOTFS_VERSION": .DistroVersion,
                              "ROOTFS_TYPE": .Type,
                              "ROOTFS_URL": .URL,
                              "ROOTFS_HASH": .Hash,
                              "BASE_IMAGE": "ubuntu:24.04",
                              "TAG_VERSION": (
                                  if .DistroMatch == "ubuntu" then (.DistroVersion | gsub("\\."; ""))
                                  elif .DistroMatch == "fedora" then "f" + .DistroVersion
                                  else "unknown"
                                  end
                              )
                              }
                          ]
                          }
                      ')
                      ;;
                      
                      "custom")
                      echo "üé® Building custom distribution selection with Ubuntu 24.04 base"
                      CUSTOM_DISTROS="${{ github.event.inputs.custom_distros }}"
                      if [ -z "$CUSTOM_DISTROS" ]; then
                          echo "‚ùå Custom distributions not specified"
                          exit 1
                      fi
                      
                      # Parse and validate custom distributions (e.g., "ubuntu-24.04,fedora-40")
                      MATRIX='{"include":[]}'
                      IFS=',' read -ra DISTRO_ARRAY <<< "$CUSTOM_DISTROS"
                      for distro in "${DISTRO_ARRAY[@]}"; do
                          IFS='-' read -ra PARTS <<< "$distro"
                          OS="${PARTS[0]}"
                          VERSION="${PARTS[1]}"
                          
                          # Validate supported distributions
                          if [ "$OS" != "ubuntu" ] && [ "$OS" != "fedora" ]; then
                              echo "‚ùå Unsupported OS: $OS (only ubuntu 22.04+ and fedora supported)"
                              continue
                          fi
                          
                          # Block Ubuntu 20.04 explicitly due to FEX compatibility
                          if [ "$OS" = "ubuntu" ] && [ "$VERSION" = "20.04" ]; then
                              echo "‚ùå Ubuntu 20.04 not supported (FEX compatibility issues)"
                              continue
                          fi
                          
                          # Find matching entry in RootFS data
                          ENTRY=$(echo "$ROOTFS_DATA" | jq -r --arg os "$OS" --arg version "$VERSION" '
                          .v1 | to_entries[] | select(.value.DistroMatch == $os and .value.DistroVersion == $version and .value.Type == "squashfs") | .value
                          ')
                          
                          if [ "$ENTRY" != "null" ] && [ -n "$ENTRY" ]; then
                              # Extract RootFS metadata
                              ROOTFS_TYPE=$(echo "$ENTRY" | jq -r '.Type')
                              ROOTFS_URL=$(echo "$ENTRY" | jq -r '.URL')
                              ROOTFS_HASH=$(echo "$ENTRY" | jq -r '.Hash')
                            
                              case "$OS" in
                                  "ubuntu") TAG_VERSION="${VERSION//./}" ;;
                                  "fedora") TAG_VERSION="f$VERSION" ;;
                              esac
                            
                              ITEM=$(jq -n \
                                  --arg os "$OS" \
                                  --arg version "$VERSION" \
                                  --arg type "$ROOTFS_TYPE" \
                                  --arg url "$ROOTFS_URL" \
                                  --arg hash "$ROOTFS_HASH" \
                                  --arg tag "$TAG_VERSION" '
                                  {
                                  "ROOTFS_OS": $os,
                                  "ROOTFS_VERSION": $version,
                                  "ROOTFS_TYPE": $type,
                                  "ROOTFS_URL": $url,
                                  "ROOTFS_HASH": $hash,
                                  "BASE_IMAGE": "ubuntu:24.04",
                                  "TAG_VERSION": $tag
                                  }
                              ')
                            
                              MATRIX=$(echo "$MATRIX" | jq -c --argjson item "$ITEM" '.include += [$item]')
                              echo "‚úÖ Added: $distro (Type: $ROOTFS_TYPE, Hash: $ROOTFS_HASH)"
                          else
                              echo "‚ùå Distribution not found: $distro"
                          fi
                      done
                      ;;
                      
                      *)
                      echo "‚ùå Unknown build scope: $BUILD_SCOPE"
                      exit 1
                      ;;
                  esac

                  # Apply EOL filtering to generated matrix
                  UBUNTU_EOL_VERSIONS="${{ steps.get-eol.outputs.ubuntu-eol-versions }}"
                  FEDORA_EOL_VERSIONS="${{ steps.get-eol.outputs.fedora-eol-versions }}"

                  echo "$MATRIX" | jq -c '.include[]' > /tmp/matrix_items.jsonl
                  > /tmp/filtered_items.jsonl

                  while IFS= read -r item; do
                      OS=$(echo "$item" | jq -r '.ROOTFS_OS')
                      VERSION=$(echo "$item" | jq -r '.ROOTFS_VERSION')
                      
                      SKIP=false
                      if [ "$OS" = "ubuntu" ] && echo "|$UBUNTU_EOL_VERSIONS|" | grep -q "|$VERSION|"; then
                          echo "‚è© Skipping EOL Ubuntu $VERSION"
                          SKIP=true
                      elif [ "$OS" = "fedora" ] && echo "|$FEDORA_EOL_VERSIONS|" | grep -q "|$VERSION|"; then
                          echo "‚è© Skipping EOL Fedora $VERSION"
                          SKIP=true
                      fi
                      
                      [ "$SKIP" = "false" ] && echo "$item" >> /tmp/filtered_items.jsonl
                  done < /tmp/matrix_items.jsonl

                  if [ -s /tmp/filtered_items.jsonl ]; then
                      FILTERED_MATRIX=$(echo '{"include":[]}' | jq --slurpfile items /tmp/filtered_items.jsonl '.include = $items')
                  else
                      FILTERED_MATRIX='{"include":[]}'
                  fi

                  MATRIX_SIZE=$(echo "$FILTERED_MATRIX" | jq '.include | length')
                  echo "filtered-matrix=$(echo "$FILTERED_MATRIX" | jq -c .)" >> $GITHUB_OUTPUT
                  echo "has-builds=$([ "$MATRIX_SIZE" -gt 0 ] && echo "true" || echo "false")" >> $GITHUB_OUTPUT
                  echo "üìä Final matrix size after EOL filtering: $MATRIX_SIZE distributions"
                  echo "üèóÔ∏è All builds will use Ubuntu 24.04 as base image for maximum compatibility"

                  # Cleanup temporary files
                  rm -f /tmp/matrix_items.jsonl /tmp/filtered_items.jsonl

    build-arm:
        needs: prepare-and-generate
        if: needs.prepare-and-generate.outputs.has-builds == 'true'
        runs-on: ${{ github.event.inputs.runner == 'self-hosted-arm64' && fromJSON('["self-hosted", "linux", "arm64"]') || github.event.inputs.runner }}
        permissions:
            contents: read
            packages: write
            actions: read
        strategy:
            matrix: ${{ fromJson(needs.prepare-and-generate.outputs.filtered-matrix) }}
            fail-fast: false # Continue parallel builds even if individual builds fail
        steps:
            - name: Disable AppArmor on the GitHub runner
              uses: cisagov/action-disable-apparmor@v1
              continue-on-error: true

            - name: Display build target information
              run: |
                  echo "üéØ Building container with Ubuntu 24.04 base for: ${{ matrix.ROOTFS_OS }} ${{ matrix.ROOTFS_VERSION }}"
                  echo "‚úÖ Distribution passed EOL filtering"
                  echo "üì¶ Base image: ${{ matrix.BASE_IMAGE }} (Ubuntu 24.04 LTS)"
                  echo "üè∑Ô∏è Container tag: ${{ matrix.TAG_VERSION }}"
                  echo "üîß FEX version: ${{ needs.prepare-and-generate.outputs.fex_semantic }}"
                  echo "üì¶ RootFS: ${{ matrix.ROOTFS_OS }}-${{ matrix.ROOTFS_VERSION }} (${{ matrix.ROOTFS_TYPE }})"

            - name: Check existing images via GHCR API
              id: check-images
              run: |
                  RELEASE_TAG="${{ matrix.ROOTFS_OS }}-${{ matrix.ROOTFS_VERSION }}-${{ needs.prepare-and-generate.outputs.fex_semantic }}"
                  IMAGE_NAME="${{ github.repository }}"

                  echo "üîç Checking if Ubuntu-based image exists via GHCR tags API..."
                  echo "üè∑Ô∏è Target tag: $RELEASE_TAG"

                  # Authenticate with GHCR using GitHub token
                  TOKEN=$(echo -n "${{ secrets.GITHUB_TOKEN }}" | base64)

                  # Query GHCR for existing tags
                  TAGS_RESPONSE=$(curl -s -H "Authorization: Bearer ${TOKEN}" \
                  "https://ghcr.io/v2/${IMAGE_NAME}/tags/list" 2>/dev/null || echo '{"tags":[]}')

                  echo "üìã GHCR API response: $TAGS_RESPONSE"

                  # Check if our version-specific tag exists
                  if echo "$TAGS_RESPONSE" | jq -e --arg TAG "$RELEASE_TAG" '.tags | index($TAG)' >/dev/null 2>&1; then
                  echo "‚úÖ Ubuntu-based image $RELEASE_TAG already exists, skipping build"
                  echo "build_fexbash=false" >> $GITHUB_OUTPUT
                  elif [ "${{ github.event.inputs.force_rebuild }}" = "true" ]; then
                  echo "üîÑ Force rebuild enabled, building anyway"
                  echo "build_fexbash=true" >> $GITHUB_OUTPUT
                  else
                  echo "‚ùå Ubuntu-based image $RELEASE_TAG not found, proceeding with build"
                  echo "build_fexbash=true" >> $GITHUB_OUTPUT
                  fi

            - name: Checkout repository source
              if: steps.check-images.outputs.build_fexbash == 'true'
              uses: actions/checkout@v4

            - name: Set up QEMU
              uses: docker/setup-qemu-action@v3
              with:
                  platforms: linux/arm64
                  cache-image: true
            - name: Configure Docker Buildx with advanced settings
              id: setup-buildx
              if: steps.check-images.outputs.build_fexbash == 'true'
              uses: docker/setup-buildx-action@v3
              with:
                  driver: docker-container
                  use: true
                  install: true
                  platforms: linux/arm64
                  driver-opts: |
                      network=host
                      image=moby/buildkit:buildx-stable-1

            - name: Authenticate with GitHub Container Registry
              if: steps.check-images.outputs.build_fexbash == 'true'
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Authenticate with Docker Hub
              if: steps.check-images.outputs.build_fexbash == 'true'
              uses: docker/login-action@v3
              with:
                  username: supersunho
                  password: ${{ secrets.DOCKERHUB_TOKEN }}

            # Version-specific FEX source handling
            - name: Get FEX commit for target version
              if: steps.check-images.outputs.build_fexbash == 'true'
              id: fex-commit
              run: |
                  TARGET_VERSION="${{ needs.prepare-and-generate.outputs.version }}"

                  if [ "$TARGET_VERSION" = "latest" ] || [ -z "$TARGET_VERSION" ]; then
                    # Use latest main branch for "latest" builds
                    FEX_COMMIT=$(curl -s https://api.github.com/repos/FEX-Emu/FEX/commits/main | jq -r '.sha[:7]')
                    echo "üîç Using latest main commit: $FEX_COMMIT"
                  else
                    # Use specific tag commit for version builds
                    FEX_COMMIT=$(curl -s "https://api.github.com/repos/FEX-Emu/FEX/git/refs/tags/$TARGET_VERSION" | jq -r '.object.sha[:7]' 2>/dev/null || echo "main")
                    if [ "$FEX_COMMIT" = "main" ] || [ "$FEX_COMMIT" = "null" ]; then
                      echo "‚ö†Ô∏è Tag $TARGET_VERSION not found, fallback to main branch"
                      FEX_COMMIT=$(curl -s https://api.github.com/repos/FEX-Emu/FEX/commits/main | jq -r '.sha[:7]')
                    fi
                    echo "üéØ Using version $TARGET_VERSION commit: $FEX_COMMIT"
                  fi

                  echo "commit=$FEX_COMMIT" >> $GITHUB_OUTPUT

            - name: Initialize Ubuntu-specific package cache directories
              run: |
                  mkdir -p /tmp/apt-cache /tmp/.ccache /tmp/apt-lib
                  echo "üìÅ Ubuntu cache directories initialized"

            # Ubuntu-specific caching
            - name: Cache Ubuntu packages with version isolation
              uses: actions/cache@v4
              id: system-cache
              with:
                  path: |
                      /tmp/apt-cache 
                      /tmp/.ccache
                      /tmp/apt-lib
                  key: ${{ env.CACHE_VERSION }}-ubuntu-cache-${{ runner.os }}-${{ runner.arch }}-${{ matrix.ROOTFS_OS }}-${{ matrix.ROOTFS_VERSION }}-${{ needs.prepare-and-generate.outputs.fex_semantic }}-${{ steps.fex-commit.outputs.commit }}
                  restore-keys: |
                      ${{ env.CACHE_VERSION }}-ubuntu-cache-${{ runner.os }}-${{ runner.arch }}-${{ matrix.ROOTFS_OS }}-${{ matrix.ROOTFS_VERSION }}-${{ needs.prepare-and-generate.outputs.fex_semantic }}-

            - name: Inject Ubuntu caches into Docker build context
              if: steps.check-images.outputs.build_fexbash == 'true'
              uses: reproducible-containers/buildkit-cache-dance@v3.1.2
              with:
                  cache-map: |
                      {
                          "apt-cache": "/var/cache/apt", 
                          "apt-lib": "/var/lib/apt",
                          "fex-ccache": "/tmp/.ccache"
                      }
                  skip-extraction: ${{ steps.system-cache.outputs.cache-hit }}

            # Version-specific FEX source caching
            - name: Cache FEX source with version-specific keys
              if: steps.check-images.outputs.build_fexbash == 'true'
              id: cache-fex-source
              uses: actions/cache@v4
              with:
                  path: /tmp/fex-source
                  key: ${{ env.CACHE_VERSION }}-fex-source-${{ needs.prepare-and-generate.outputs.fex_semantic }}-${{ steps.fex-commit.outputs.commit }}
                  restore-keys: |
                      ${{ env.CACHE_VERSION }}-fex-source-${{ needs.prepare-and-generate.outputs.fex_semantic }}-

            # Version-aware FEX source cloning
            - name: Clone FEX source for target version
              if: github.event.inputs.force_rebuild == 'true' || (steps.check-images.outputs.build_fexbash == 'true' && steps.cache-fex-source.outputs.cache-hit != 'true')
              run: |
                  rm -rf /tmp/fex-source

                  TARGET_VERSION="${{ needs.prepare-and-generate.outputs.version }}"

                  if [ "$TARGET_VERSION" = "latest" ] || [ -z "$TARGET_VERSION" ]; then
                    echo "üîç Cloning latest FEX main branch..."
                    git clone --recurse-submodules https://github.com/FEX-Emu/FEX.git /tmp/fex-source
                  else
                    echo "üéØ Cloning FEX for specific version: $TARGET_VERSION"
                    # Attempt to checkout specific tag
                    git clone --recurse-submodules --branch "$TARGET_VERSION" https://github.com/FEX-Emu/FEX.git /tmp/fex-source 2>/dev/null || \
                    {
                      echo "‚ö†Ô∏è Tag $TARGET_VERSION not found, falling back to main branch"
                      git clone --recurse-submodules https://github.com/FEX-Emu/FEX.git /tmp/fex-source
                    }
                  fi

                  echo "üìã FEX source prepared: $(cd /tmp/fex-source && git rev-parse --short HEAD)"

            # Enhanced Docker build with Ubuntu support
            - name: Build and push Ubuntu-based images to multiple registries
              if: steps.check-images.outputs.build_fexbash == 'true'
              id: build
              uses: docker/build-push-action@v5
              with:
                  context: .
                  file: ./${{github.event.inputs.custom_dockerfile}}
                  platforms: linux/arm64
                  push: ${{ github.event_name != 'pull_request' }}
                  tags: |
                      ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ matrix.ROOTFS_OS }}-${{ matrix.ROOTFS_VERSION }}-${{ needs.prepare-and-generate.outputs.fex_semantic }}
                      ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ matrix.ROOTFS_OS }}-${{ matrix.ROOTFS_VERSION }}
                      ${{ env.DOCKERHUB_REPO }}:${{ matrix.ROOTFS_OS }}-${{ matrix.ROOTFS_VERSION }}-${{ needs.prepare-and-generate.outputs.fex_semantic }}
                      ${{ env.DOCKERHUB_REPO }}:${{ matrix.ROOTFS_OS }}-${{ matrix.ROOTFS_VERSION }}
                  no-cache: ${{ github.event.inputs.clear_cache == 'true' }}
                  cache-from: |
                      type=gha,scope=${{ env.CACHE_VERSION }}-ubuntu-${{ matrix.ROOTFS_OS }}-${{ matrix.ROOTFS_VERSION }}-${{ needs.prepare-and-generate.outputs.fex_semantic }}
                  cache-to: |
                      type=gha,mode=min,scope=${{ env.CACHE_VERSION }}-ubuntu-${{ matrix.ROOTFS_OS }}-${{ matrix.ROOTFS_VERSION }}-${{ needs.prepare-and-generate.outputs.fex_semantic }}
                  build-contexts: |
                      fex-sources=/tmp/fex-source
                  build-args: |
                      TARGETPLATFORM=linux/arm64
                      BASE_IMAGE=${{ matrix.BASE_IMAGE }}
                      ROOTFS_OS=${{ matrix.ROOTFS_OS }}
                      ROOTFS_VERSION=${{ matrix.ROOTFS_VERSION }}
                      ROOTFS_TYPE=${{ matrix.ROOTFS_TYPE }}
                      ROOTFS_URL=${{ matrix.ROOTFS_URL }}
                      LLVM_VERSION=${{ env.LLVM_VERSION }}
                      CCACHE_DIR=/tmp/.ccache
                      ENABLE_CCACHE=true
                      FEX_VERSION=${{ needs.prepare-and-generate.outputs.fex_semantic }}

            - name: Display pushed Ubuntu-based images information
              if: steps.check-images.outputs.build_fexbash == 'true'
              run: |
                  echo "üéâ Ubuntu-based images pushed successfully to multiple registries!"
                  echo ""
                  echo "üèóÔ∏è Ubuntu 24.04 Base with maximum compatibility"
                  echo "üì¶ GitHub Container Registry (GHCR):"
                  echo "  - ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ matrix.ROOTFS_OS }}-${{ matrix.ROOTFS_VERSION }}"
                  echo "  - ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ matrix.ROOTFS_OS }}-${{ matrix.ROOTFS_VERSION }}-${{ needs.prepare-and-generate.outputs.fex_semantic }}"
                  echo ""
                  echo "üê≥ Docker Hub:"
                  echo "  - ${{ env.DOCKERHUB_REPO }}:${{ matrix.ROOTFS_OS }}-${{ matrix.ROOTFS_VERSION }}"
                  echo "  - ${{ env.DOCKERHUB_REPO }}:${{ matrix.ROOTFS_OS }}-${{ matrix.ROOTFS_VERSION }}-${{ needs.prepare-and-generate.outputs.fex_semantic }}"
                  echo ""
                  echo "üöÄ Quick Access (Ubuntu-optimized):"
                  echo "  docker pull ${{ env.DOCKERHUB_REPO }}:${{ matrix.ROOTFS_OS }}-${{ matrix.ROOTFS_VERSION }}"
                  echo "  docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ matrix.ROOTFS_OS }}-${{ matrix.ROOTFS_VERSION }}"
                  echo ""
                  echo "üí° Ubuntu 24.04 base provides maximum compatibility and stability"

            - name: Comprehensive container verification suite
              if: steps.check-images.outputs.build_fexbash == 'true' && github.event.inputs.verify_build == 'true'
              run: |
                  IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ matrix.ROOTFS_OS }}-${{ matrix.ROOTFS_VERSION }}-${{ needs.prepare-and-generate.outputs.fex_semantic }}"

                  echo "üîç Starting comprehensive FEXBash verification suite on Ubuntu base..."

                  # Test 1: Binary and permission verification
                  echo "üìã Test 1: Binary Verification (Ubuntu)"
                  docker run --rm --platform linux/arm64 "$IMAGE" test -f /usr/local/fex/bin/FEXBash && echo " - ‚úÖ FEXBash binary exists" || echo " - ‚ùå FEXBash binary missing"
                  docker run --rm --platform linux/arm64 "$IMAGE" test -x /usr/local/fex/bin/FEXBash && echo " - ‚úÖ FEXBash is executable" || echo " - ‚ùå FEXBash not executable"

                  # Test 2: RootFS integrity verification
                  echo "üìã Test 2: RootFS Integrity Verification (Ubuntu)"
                  docker run --rm --platform linux/arm64 "$IMAGE" test -d /home/fex/.fex-emu/RootFS && echo " - ‚úÖ RootFS directory exists" || echo " - ‚ùå RootFS directory missing"
                  docker run --rm --platform linux/arm64 "$IMAGE" test -f /home/fex/.fex-emu/Config.json && echo " - ‚úÖ FEX Config.json exists" || echo " - ‚ùå Config.json missing"
                  docker run --rm --platform linux/arm64 "$IMAGE" ls -la /home/fex/.fex-emu/RootFS/ 2>/dev/null | wc -l | grep -q "^[1-9]" && echo " - ‚úÖ RootFS contains distribution" || echo " - ‚ùå RootFS distribution missing"

                  # Test 3: Ubuntu glibc compatibility verification
                  echo "üìã Test 3: Ubuntu glibc Compatibility Tests"
                  docker run --rm --platform linux/arm64 "$IMAGE" ldd --version | head -1 && echo " - ‚úÖ glibc compatibility working" || echo " - ‚ùå glibc compatibility failed"
                  docker run --rm --platform linux/arm64 "$IMAGE" FEXBash -c "uname -m | grep -q x86_64" && echo " - ‚úÖ x86_64 architecture emulation working" || echo " - ‚ùå Architecture emulation failed"
                  docker run --rm --platform linux/arm64 "$IMAGE" FEXBash -c "echo 'FEX Emulation Test Passed'" >/dev/null && echo " - ‚úÖ Basic shell execution working" || echo " - ‚ùå Basic execution failed"
                  docker run --rm --platform linux/arm64 "$IMAGE" FEXBash -c "ls /usr/bin | head -5" >/dev/null && echo " - ‚úÖ x86 binary execution working" || echo " - ‚ùå x86 binary execution failed"

                  # Test 4: Performance and resource verification
                  echo "üìã Test 4: Performance Verification (Ubuntu)"
                  docker run --rm --platform linux/arm64 "$IMAGE" FEXBash -c "time ls /usr/bin >/dev/null" 2>&1 | grep -q "real\|user\|sys" && echo " - ‚úÖ Performance timing working" || echo " - ‚ùå Performance timing failed"

                  echo "üéâ All Ubuntu verification tests completed for ${{ matrix.ROOTFS_OS }} ${{ matrix.ROOTFS_VERSION }}!"

            - name: Display Ubuntu cache utilization statistics
              run: |
                  echo "üìä Ubuntu Cache Utilization Statistics for FEX ${{ needs.prepare-and-generate.outputs.fex_semantic }}:"
                  echo "üóÇÔ∏è APT Cache: $(du -sh /tmp/apt-cache 2>/dev/null | cut -f1 || echo '0B')"
                  echo "üóÇÔ∏è ccache: $(du -sh /tmp/.ccache 2>/dev/null | cut -f1 || echo '0B')"
                  echo "üóÇÔ∏è FEX Source: $(du -sh /tmp/fex-source 2>/dev/null | cut -f1 || echo '0B')"
                  echo "üíæ Cache Hit Status: Ubuntu=${{ steps.system-cache.outputs.cache-hit }}, FEX=${{ steps.cache-fex-source.outputs.cache-hit }}"
                  echo "üéØ Ubuntu optimization: Stable and reliable caching with maximum compatibility"

            - name: Export digest for multi-arch manifest
              if: steps.check-images.outputs.build_fexbash == 'true'
              run: |
                  mkdir -p /tmp/digests/${{ matrix.ROOTFS_OS }}-${{ matrix.TAG_VERSION }}
                  echo "${{ steps.build.outputs.digest }}" > /tmp/digests/${{ matrix.ROOTFS_OS }}-${{ matrix.TAG_VERSION }}/digest
                  echo "üìã Ubuntu digest exported for ${{ matrix.ROOTFS_OS }}-${{ matrix.TAG_VERSION }}"

            - name: Upload build digest artifact
              if: steps.check-images.outputs.build_fexbash == 'true'
              uses: actions/upload-artifact@v4
              with:
                  name: digests-${{ matrix.ROOTFS_OS }}-${{ matrix.TAG_VERSION }}
                  path: /tmp/digests/${{ matrix.ROOTFS_OS }}-${{ matrix.TAG_VERSION }}/*
                  retention-days: 1

    # Enhanced multi-platform manifest creation
    merge-manifests:
        needs: [prepare-and-generate, build-arm]
        if: always() && needs.build-arm.result == 'success'
        runs-on: ${{ github.event.inputs.runner == 'self-hosted-arm64' && fromJSON('["self-hosted", "linux", "arm64"]') || github.event.inputs.runner }}
        permissions:
            contents: read
            packages: write
        steps:
            - name: Download all build digests
              uses: actions/download-artifact@v4
              with:
                  path: /tmp/digests
                  pattern: digests-*
                  merge-multiple: true

            - name: Setup Docker Buildx for manifest operations
              uses: docker/setup-buildx-action@v3

            - name: Authenticate with GitHub Container Registry
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Authenticate with Docker Hub
              uses: docker/login-action@v3
              with:
                  username: supersunho
                  password: ${{ secrets.DOCKERHUB_TOKEN }}

            - name: Create comprehensive multi-platform manifests for Ubuntu-based images
              run: |
                  MATRIX='${{ needs.prepare-and-generate.outputs.filtered-matrix }}'
                  FEX_VERSION="${{ needs.prepare-and-generate.outputs.fex_semantic }}"

                  echo "üîç Processing Ubuntu-based matrix for manifest creation..."

                  # Collect successfully built Ubuntu images for both registries
                  EXISTING_GHCR_IMAGES=""
                  EXISTING_DOCKERHUB_IMAGES=""

                  for item in $(echo "$MATRIX" | jq -r '.include[] | "\(.ROOTFS_OS)-\(.ROOTFS_VERSION)"'); do
                      VERSION_TAG="$item-$FEX_VERSION"
                      LATEST_TAG="$item"
                      
                      # Check GHCR images
                      if docker manifest inspect ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$VERSION_TAG >/dev/null 2>&1; then
                          EXISTING_GHCR_IMAGES="$EXISTING_GHCR_IMAGES ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$VERSION_TAG"
                          echo "‚úÖ Found Ubuntu GHCR image: $VERSION_TAG"
                      fi
                      
                      # Check Docker Hub images
                      if docker manifest inspect ${{ env.DOCKERHUB_REPO }}:$VERSION_TAG >/dev/null 2>&1; then
                          EXISTING_DOCKERHUB_IMAGES="$EXISTING_DOCKERHUB_IMAGES ${{ env.DOCKERHUB_REPO }}:$VERSION_TAG"
                          echo "‚úÖ Found Ubuntu Docker Hub image: $VERSION_TAG"
                      fi
                  done

                  # Create GHCR manifests for Ubuntu images
                  if [ -n "$EXISTING_GHCR_IMAGES" ]; then
                      echo "üèóÔ∏è Creating Ubuntu-based GHCR multi-platform manifests..."
                      
                      # Version-specific latest manifest
                      docker buildx imagetools create \
                          -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest-$FEX_VERSION \
                          $EXISTING_GHCR_IMAGES
                      echo "‚úÖ Created Ubuntu GHCR version-specific manifest: latest-$FEX_VERSION"
                      
                      # Global latest manifest
                      docker buildx imagetools create \
                          -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
                          $EXISTING_GHCR_IMAGES
                      echo "‚úÖ Created Ubuntu GHCR global latest manifest"
                      
                      # Distribution-specific manifests
                      for distro in ubuntu fedora; do
                          DISTRO_IMAGES=$(echo "$EXISTING_GHCR_IMAGES" | tr ' ' '\n' | grep ":$distro-" || echo "")
                          if [ -n "$DISTRO_IMAGES" ]; then
                              docker buildx imagetools create \
                                  -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$distro-latest \
                                  $DISTRO_IMAGES
                              echo "‚úÖ Created Ubuntu GHCR $distro-specific manifest: $distro-latest"
                          fi
                      done
                  fi

                  # Create Docker Hub manifests for Ubuntu images
                  if [ -n "$EXISTING_DOCKERHUB_IMAGES" ]; then
                      echo "üê≥ Creating Ubuntu-based Docker Hub multi-platform manifests..."
                      
                      # Version-specific latest manifest
                      docker buildx imagetools create \
                          -t ${{ env.DOCKERHUB_REPO }}:latest-$FEX_VERSION \
                          $EXISTING_DOCKERHUB_IMAGES
                      echo "‚úÖ Created Ubuntu Docker Hub version-specific manifest: latest-$FEX_VERSION"
                      
                      # Global latest manifest
                      docker buildx imagetools create \
                          -t ${{ env.DOCKERHUB_REPO }}:latest \
                          $EXISTING_DOCKERHUB_IMAGES
                      echo "‚úÖ Created Ubuntu Docker Hub global latest manifest"
                      
                      # Distribution-specific manifests
                      for distro in ubuntu fedora; do
                          DISTRO_IMAGES=$(echo "$EXISTING_DOCKERHUB_IMAGES" | tr ' ' '\n' | grep ":$distro-" || echo "")
                          if [ -n "$DISTRO_IMAGES" ]; then
                              docker buildx imagetools create \
                                  -t ${{ env.DOCKERHUB_REPO }}:$distro-latest \
                                  $DISTRO_IMAGES
                              echo "‚úÖ Created Ubuntu Docker Hub $distro-specific manifest: $distro-latest"
                          fi
                      done
                  fi
                      
                  echo "üéâ All Ubuntu-based manifests created successfully for both registries"
                  echo "üèóÔ∏è Ubuntu base provides maximum compatibility while maintaining full functionality"

    # Enhanced GitHub release with comprehensive information
    create-release:
        needs: [prepare-and-generate, merge-manifests]
        if: always() && needs.merge-manifests.result == 'success'
        runs-on: ${{ github.event.inputs.runner == 'self-hosted-arm64' && fromJSON('["self-hosted", "linux", "arm64"]') || github.event.inputs.runner }}
        permissions:
            contents: write
        steps:
            - name: Create comprehensive GitHub Release for Ubuntu-based builds
              uses: softprops/action-gh-release@v1
              with:
                  tag_name: ${{ needs.prepare-and-generate.outputs.version }}-build-${{ github.run_number }}
                  name: "FEXBash Ubuntu-Optimized Release ${{ needs.prepare-and-generate.outputs.version }} (Build #${{ github.run_number }})"
                  body: |
                      # üöÄ FEX-Emu Ubuntu-Optimized ARM64 Container Release ${{ needs.prepare-and-generate.outputs.version }}

                      **Build Date**: $(date '+%Y-%m-%d %H:%M:%S UTC')  
                      **FEX Version**: ${{ needs.prepare-and-generate.outputs.fex_semantic }}  
                      **Base Architecture**: Ubuntu 24.04 LTS for maximum compatibility  
                      **Build Strategy**: Version-isolated caching with optimized Ubuntu foundation  
                      **Architecture**: ARM64 native compilation and execution  
                      **Container Registries**: GitHub Container Registry (GHCR) + Docker Hub  
                      **Build Workflow**: #${{ github.run_number }}

                      ## üèóÔ∏è Ubuntu Optimization Highlights

                      - **Maximum Compatibility**: Ubuntu 24.04 LTS provides proven stability
                      - **glibc Foundation**: Native glibc support for x86 emulation
                      - **Enterprise Ready**: LTS support until 2029 with security updates
                      - **Multi-RootFS Support**: Ubuntu/Fedora RootFS with Ubuntu base

                      ## üì¶ Available Container Images (Ubuntu-Optimized)

                      ### üéØ Fast Download (Docker Hub - Recommended)
                      ```
                      # Latest Ubuntu-optimized release (maximum compatibility)
                      docker pull ${{ env.DOCKERHUB_REPO }}:latest

                      # Version-specific Ubuntu build
                      docker pull ${{ env.DOCKERHUB_REPO }}:latest-${{ needs.prepare-and-generate.outputs.fex_semantic }}
                      ```

                      ### üêß Ubuntu RootFS with Ubuntu Base (Perfect Match)
                      ```
                      # Ubuntu 24.04 LTS RootFS on Ubuntu base (Recommended combination)
                      docker pull ${{ env.DOCKERHUB_REPO }}:ubuntu-24.04
                      docker pull ${{ env.DOCKERHUB_REPO }}:ubuntu-24.04-${{ needs.prepare-and-generate.outputs.fex_semantic }}

                      # Ubuntu 22.04 LTS RootFS on Ubuntu base
                      docker pull ${{ env.DOCKERHUB_REPO }}:ubuntu-22.04
                      docker pull ${{ env.DOCKERHUB_REPO }}:ubuntu-22.04-${{ needs.prepare-and-generate.outputs.fex_semantic }}

                      # Ubuntu latest distribution
                      docker pull ${{ env.DOCKERHUB_REPO }}:ubuntu-latest
                      ```

                      ### üé© Fedora RootFS with Ubuntu Base (Cross-compatibility)
                      ```
                      # Fedora 40 RootFS on Ubuntu base
                      docker pull ${{ env.DOCKERHUB_REPO }}:fedora-40
                      docker pull ${{ env.DOCKERHUB_REPO }}:fedora-40-${{ needs.prepare-and-generate.outputs.fex_semantic }}

                      # Fedora latest distribution
                      docker pull ${{ env.DOCKERHUB_REPO }}:fedora-latest
                      ```

                      ### üîÑ Alternative Registry (GitHub Container Registry)
                      ```
                      # GHCR Ubuntu-optimized images (alternative source)
                      docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
                      docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:ubuntu-24.04
                      docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:fedora-40
                      ```

                      ## üöÄ Quick Start Guide (Ubuntu-Optimized)

                      ### Interactive x86 Shell on ARM64
                      ```
                      # Launch Ubuntu-optimized FEXBash environment
                      docker run -it --rm ${{ env.DOCKERHUB_REPO }}:latest

                      # Execute x86 command with maximum compatibility
                      docker run --rm ${{ env.DOCKERHUB_REPO }}:latest \
                          FEXBash -c "uname -a"
                      ```

                      ### Development Environment Setup
                      ```
                      # Stable development environment (Ubuntu base)
                      docker run -it --rm \
                          -v fex-rootfs:/home/fex/.fex-emu/RootFS \
                          -v $(pwd):/workspace \
                          -w /workspace \
                          ${{ env.DOCKERHUB_REPO }}:ubuntu-24.04
                      ```

                      ## üîß Ubuntu-Specific Technical Specifications

                      ### Build Environment (Ubuntu-Optimized)
                      - **Base Image**: Ubuntu 24.04 LTS (2029 support end)
                      - **glibc Version**: Native Ubuntu glibc for x86 emulation
                      - **Compiler Toolchain**: LLVM ${{ env.LLVM_VERSION }} with native Ubuntu packages
                      - **Package Manager**: APT with efficient caching
                      - **Size Strategy**: Multi-stage builds with Ubuntu efficiency

                      ### Container Features (Ubuntu-Enhanced)
                      - **Maximum Compatibility**: Ubuntu LTS proven stability
                      - **glibc Native**: Seamless x86 binary execution
                      - **Enterprise Support**: LTS lifecycle with security updates
                      - **Performance**: Optimized Ubuntu package selection

                      ## üìä Ubuntu Performance Benefits

                      ### Compatibility Comparison
                      | Component | Alpine Base | Ubuntu Base | Advantage |
                      |-----------|-------------|-------------|-----------|
                      | **glibc Support** | Third-party | Native | Ubuntu: Native |
                      | **Package Ecosystem** | Limited | Extensive | Ubuntu: +1000s |
                      | **LTS Support** | Rolling | 5 years | Ubuntu: Longer |
                      | **x86 Compatibility** | Good | Excellent | Ubuntu: Better |

                      ### Stability Improvements
                      - **LTS Foundation**: 5-year support lifecycle with predictable updates
                      - **Native glibc**: No compatibility layers needed for x86 emulation
                      - **Proven Platform**: Enterprise-grade stability and reliability
                      - **Package Maturity**: Well-tested Ubuntu package ecosystem

                      ## üõ†Ô∏è Ubuntu-Specific Build Configuration

                      ### Ubuntu Package Optimization
                      - **Native Dependencies**: Ubuntu-provided LLVM and build tools
                      - **APT Efficiency**: Optimized package caching and management
                      - **LTS Stability**: Long-term support with security patches
                      - **Compatibility First**: Maximum x86 emulation compatibility

                      ### glibc Advantage
                      - **Native Support**: Ubuntu's native glibc implementation
                      - **x86 Compatibility**: Perfect compatibility with x86 applications
                      - **Library Ecosystem**: Extensive Ubuntu library support

                      ## üéØ Why Ubuntu Base is Optimal

                      1. **Stability**: Ubuntu 24.04 LTS provides 5-year support lifecycle
                      2. **Compatibility**: Native glibc for perfect x86 emulation support  
                      3. **Ecosystem**: Extensive package ecosystem and community support
                      4. **Enterprise**: Proven platform for production deployments
                      5. **Flexibility**: Universal base supporting all RootFS types

                      ---

                      **üöÄ Ready for the most stable FEX experience?**  
                      **Start with**: `docker run -it --rm ${{ env.DOCKERHUB_REPO }}:ubuntu-24.04`

                      **üìñ Need help?** Check our [Documentation](https://github.com/${{ github.repository }}) or join the [FEX Community](https://discord.gg/fex-emu)

                      **‚≠ê Love the Ubuntu optimization?** Star the repository and share the stability benefits!
                  draft: false
                  prerelease: false
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # Build summary with Ubuntu-specific information
    build-summary:
        needs: [prepare-and-generate, build-arm, merge-manifests, create-release]
        if: always()
        runs-on: ${{ github.event.inputs.runner == 'self-hosted-arm64' && fromJSON('["self-hosted", "linux", "arm64"]') || github.event.inputs.runner }}
        steps:
            - name: Generate comprehensive Ubuntu-optimized build analytics and summary
              run: |
                  cat >> $GITHUB_STEP_SUMMARY << 'EOF'
                  # üöÄ FEX-Emu Ubuntu-Optimized ARM64 Container Build Analytics

                  ## üìä Build Execution Summary

                  EOF

                  # Build metadata with Ubuntu highlights
                  echo "**Build Date**: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
                  echo "**FEX Version**: ${{ needs.prepare-and-generate.outputs.version }} (Semantic: ${{ needs.prepare-and-generate.outputs.fex_semantic }})" >> $GITHUB_STEP_SUMMARY
                  echo "**Repository**: [${{ github.repository }}](https://github.com/${{ github.repository }})" >> $GITHUB_STEP_SUMMARY
                  echo "**Container Registries**: [GitHub Packages](${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}) + [Docker Hub](https://hub.docker.com/r/supersunho/fex-emu)" >> $GITHUB_STEP_SUMMARY
                  echo "**Base Architecture**: Ubuntu 24.04 LTS with native glibc" >> $GITHUB_STEP_SUMMARY
                  echo "**Build Strategy**: Ubuntu-optimized with version-isolated caching and multi-registry deployment" >> $GITHUB_STEP_SUMMARY
                  echo "**Compatibility**: Maximum x86 emulation compatibility with native glibc" >> $GITHUB_STEP_SUMMARY
                  echo "**Architecture**: ARM64 native compilation and execution" >> $GITHUB_STEP_SUMMARY
                  echo "**Cache Version**: ${{ env.CACHE_VERSION }}" >> $GITHUB_STEP_SUMMARY
                  echo "**Workflow Run**: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY

                  # Ubuntu-specific optimization results
                  echo "## üèóÔ∏è Ubuntu Optimization Results" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### ‚úÖ Ubuntu LTS Advantages" >> $GITHUB_STEP_SUMMARY
                  echo "- **LTS Support**: Ubuntu 24.04 supported until 2029" >> $GITHUB_STEP_SUMMARY
                  echo "- **Native glibc**: Perfect x86 emulation compatibility without layers" >> $GITHUB_STEP_SUMMARY  
                  echo "- **Package Ecosystem**: Extensive Ubuntu package repository" >> $GITHUB_STEP_SUMMARY
                  echo "- **Stability**: Enterprise-grade reliability and predictable updates" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY

                  echo "### üîß Ubuntu-Specific Optimizations Applied" >> $GITHUB_STEP_SUMMARY
                  echo "- ‚úÖ **Native glibc**: Ubuntu's native glibc implementation for x86 compatibility" >> $GITHUB_STEP_SUMMARY
                  echo "- ‚úÖ **APT Caching**: Efficient Ubuntu package caching system" >> $GITHUB_STEP_SUMMARY
                  echo "- ‚úÖ **LTS Stability**: Long-term support with security patches" >> $GITHUB_STEP_SUMMARY
                  echo "- ‚úÖ **Package Maturity**: Well-tested Ubuntu LLVM and development packages" >> $GITHUB_STEP_SUMMARY
                  echo "- ‚úÖ **Enterprise Ready**: Production-grade platform with proven track record" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY

                  # Rest of the build summary remains similar but with Ubuntu context...

                  # Build configuration
                  echo "## ‚öôÔ∏è Build Configuration" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "| Parameter | Value | Description |" >> $GITHUB_STEP_SUMMARY
                  echo "|-----------|-------|-------------|" >> $GITHUB_STEP_SUMMARY
                  echo "| **Base Image** | Ubuntu 24.04 LTS | Long-term support Linux distribution with native glibc" >> $GITHUB_STEP_SUMMARY
                  echo "| **Build Scope** | \`${{ github.event.inputs.build_scope || 'latest-only' }}\` | Distribution selection strategy |" >> $GITHUB_STEP_SUMMARY
                  echo "| **Target Version** | \`${{ needs.prepare-and-generate.outputs.version }}\` | FEX emulator version |" >> $GITHUB_STEP_SUMMARY
                  echo "| **Custom Version** | \`${{ github.event.inputs.version != 'latest' && 'Yes' || 'No' }}\` | User-specified version override |" >> $GITHUB_STEP_SUMMARY
                  echo "| **Force Rebuild** | \`${{ github.event.inputs.force_rebuild || 'false' }}\` | Ignore existing images |" >> $GITHUB_STEP_SUMMARY
                  echo "| **Verify Build** | \`${{ github.event.inputs.verify_build || 'false' }}\` | Run comprehensive verification tests |" >> $GITHUB_STEP_SUMMARY
                  echo "| **Cache Cleared** | \`${{ github.event.inputs.clear_cache || 'false' }}\` | Fresh build without cache |" >> $GITHUB_STEP_SUMMARY
                  echo "| **Runner Type** | \`${{ github.event.inputs.runner || 'ubuntu-24.04-arm' }}\` | GitHub Actions runner selection |" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY

                  # Job execution results 
                  echo "## üîß Pipeline Execution Results" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY

                  if [ "${{ needs.prepare-and-generate.result }}" = "success" ]; then
                      echo "‚úÖ **Preparation & Matrix Generation**: Successfully completed with Ubuntu optimization" >> $GITHUB_STEP_SUMMARY
                      MATRIX_SIZE=$(echo '${{ needs.prepare-and-generate.outputs.filtered-matrix }}' | jq '.include | length' 2>/dev/null || echo "0")
                      echo "   - **Matrix Size**: $MATRIX_SIZE distributions after EOL filtering" >> $GITHUB_STEP_SUMMARY
                      echo "   - **Base Image Strategy**: All builds use Ubuntu 24.04 LTS for maximum compatibility" >> $GITHUB_STEP_SUMMARY
                      echo "   - **FEX Semantic Version**: ${{ needs.prepare-and-generate.outputs.fex_semantic }}" >> $GITHUB_STEP_SUMMARY
                      echo "   - **EOL Filtering**: Applied successfully" >> $GITHUB_STEP_SUMMARY
                      echo "   - **API Integration**: RootFS data fetched from official API" >> $GITHUB_STEP_SUMMARY
                  else
                      echo "‚ùå **Preparation & Matrix Generation**: Failed" >> $GITHUB_STEP_SUMMARY
                      echo "   - Check logs for API connectivity or JSON parsing issues" >> $GITHUB_STEP_SUMMARY
                  fi
                  echo "" >> $GITHUB_STEP_SUMMARY

                  if [ "${{ needs.build-arm.result }}" = "success" ]; then
                      echo "‚úÖ **ARM64 Ubuntu Container Build**: Successfully completed with maximum compatibility" >> $GITHUB_STEP_SUMMARY
                      echo "   - **Base Image**: Ubuntu 24.04 LTS with native glibc support" >> $GITHUB_STEP_SUMMARY
                      echo "   - **Compiler**: LLVM ${{ env.LLVM_VERSION }} optimized for Ubuntu" >> $GITHUB_STEP_SUMMARY
                      echo "   - **Caching Strategy**: APT-based caching with version-specific isolation" >> $GITHUB_STEP_SUMMARY
                      echo "   - **Build System**: Ninja + CMake with ccache acceleration on Ubuntu" >> $GITHUB_STEP_SUMMARY
                      echo "   - **Registry Deployment**: Docker Hub + GHCR simultaneous push" >> $GITHUB_STEP_SUMMARY
                      echo "   - **Compatibility Achievement**: Native glibc for perfect x86 emulation" >> $GITHUB_STEP_SUMMARY
                      echo "   - **Quality Assurance**: Ubuntu-specific verification suite available" >> $GITHUB_STEP_SUMMARY
                      echo "   - **Performance**: Optimized for production deployment with LTS stability" >> $GITHUB_STEP_SUMMARY
                  else
                      echo "‚ùå **ARM64 Ubuntu Container Build**: Failed or partially completed" >> $GITHUB_STEP_SUMMARY
                      echo "   - Some distributions may have failed individual builds" >> $GITHUB_STEP_SUMMARY
                      echo "   - Check individual job logs for Ubuntu-specific failure details" >> $GITHUB_STEP_SUMMARY
                  fi
                  echo "" >> $GITHUB_STEP_SUMMARY

                  # Continue with manifest and release results...
                  if [ "${{ needs.merge-manifests.result }}" = "success" ]; then
                      echo "‚úÖ **Multi-Platform Manifests**: Created successfully for Ubuntu-based images on both registries" >> $GITHUB_STEP_SUMMARY
                      echo "   - **GHCR Ubuntu Latest**: \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest\`" >> $GITHUB_STEP_SUMMARY
                      echo "   - **Docker Hub Ubuntu Latest**: \`${{ env.DOCKERHUB_REPO }}:latest\`" >> $GITHUB_STEP_SUMMARY
                      echo "   - **Version Specific**: Ubuntu latest-${{ needs.prepare-and-generate.outputs.fex_semantic }} tags created" >> $GITHUB_STEP_SUMMARY
                      echo "   - **Distribution Specific**: Ubuntu and Fedora RootFS with Ubuntu base tags" >> $GITHUB_STEP_SUMMARY
                      echo "   - **Multi-Arch Support**: ARM64 platform tags optimized for Ubuntu efficiency" >> $GITHUB_STEP_SUMMARY
                  else
                      echo "‚ùå **Multi-Platform Manifests**: Creation failed" >> $GITHUB_STEP_SUMMARY
                      echo "   - No successfully built Ubuntu images found for manifest creation" >> $GITHUB_STEP_SUMMARY
                  fi
                  echo "" >> $GITHUB_STEP_SUMMARY

                  if [ "${{ needs.create-release.result }}" = "success" ]; then
                      echo "‚úÖ **GitHub Release**: Published successfully with Ubuntu optimization highlights" >> $GITHUB_STEP_SUMMARY
                      echo "   - **Release Tag**: \`${{ needs.prepare-and-generate.outputs.version }}-build-${{ github.run_number }}\`" >> $GITHUB_STEP_SUMMARY
                      echo "   - **Documentation**: Ubuntu-specific usage guide and optimization details" >> $GITHUB_STEP_SUMMARY
                      echo "   - **Examples**: Docker Compose and Kubernetes configurations for Ubuntu builds" >> $GITHUB_STEP_SUMMARY
                      echo "   - **Compatibility Metrics**: Ubuntu LTS benefits and glibc advantages documented" >> $GITHUB_STEP_SUMMARY
                      echo "   - **Multi-Registry Guide**: Ubuntu Docker Hub and GHCR usage instructions" >> $GITHUB_STEP_SUMMARY
                  else
                      echo "‚ùå **GitHub Release**: Publication failed" >> $GITHUB_STEP_SUMMARY
                      echo "   - Release creation encountered errors" >> $GITHUB_STEP_SUMMARY
                  fi
                  echo "" >> $GITHUB_STEP_SUMMARY

                  # Container image inventory with Ubuntu context
                  echo "## üì¶ Generated Ubuntu-Optimized Container Images" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### üéØ Primary Ubuntu Multi-Platform Images" >> $GITHUB_STEP_SUMMARY
                  echo "- **Docker Hub Ubuntu Latest**: \`${{ env.DOCKERHUB_REPO }}:latest\` (Maximum compatibility, LTS stability)" >> $GITHUB_STEP_SUMMARY
                  echo "- **GHCR Ubuntu Latest**: \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest\` (Alternative source)" >> $GITHUB_STEP_SUMMARY
                  echo "- **Version Specific**: \`latest-${{ needs.prepare-and-generate.outputs.fex_semantic }}\` Ubuntu-optimized tags" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY

                  # Parse matrix for distribution-specific images with Ubuntu context
                  FILTERED_MATRIX='${{ needs.prepare-and-generate.outputs.filtered-matrix }}'
                  if [ -n "$FILTERED_MATRIX" ] && [ "$FILTERED_MATRIX" != "null" ]; then
                      echo "### üêß Ubuntu RootFS with Ubuntu Base (Perfect Match)" >> $GITHUB_STEP_SUMMARY
                      echo "$FILTERED_MATRIX" | jq -r '.include[] | select(.ROOTFS_OS == "ubuntu") | "- **Ubuntu \(.ROOTFS_VERSION) on Ubuntu**: \`${{ env.DOCKERHUB_REPO }}:\(.ROOTFS_OS)-\(.ROOTFS_VERSION)\` | \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:\(.ROOTFS_OS)-\(.ROOTFS_VERSION)\`"' >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "- No Ubuntu RootFS + Ubuntu base images built" >> $GITHUB_STEP_SUMMARY
                      echo "" >> $GITHUB_STEP_SUMMARY
                      echo "### üé© Fedora RootFS with Ubuntu Base (Cross-compatibility)" >> $GITHUB_STEP_SUMMARY
                      echo "$FILTERED_MATRIX" | jq -r '.include[] | select(.ROOTFS_OS == "fedora") | "- **Fedora \(.ROOTFS_VERSION) on Ubuntu**: \`${{ env.DOCKERHUB_REPO }}:\(.ROOTFS_OS)-\(.ROOTFS_VERSION)\` | \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:\(.ROOTFS_OS)-\(.ROOTFS_VERSION)\`"' >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "- No Fedora RootFS + Ubuntu base images built" >> $GITHUB_STEP_SUMMARY
                  fi
                  echo "" >> $GITHUB_STEP_SUMMARY

                  # Technical specifications with Ubuntu focus
                  echo "## üîß Ubuntu-Optimized Technical Specifications" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "| Component | Specification | Ubuntu Advantages |" >> $GITHUB_STEP_SUMMARY
                  echo "|-----------|---------------|------------------|" >> $GITHUB_STEP_SUMMARY
                  echo "| **Base Image** | Ubuntu 24.04 LTS | 5-year support lifecycle vs Alpine rolling" >> $GITHUB_STEP_SUMMARY
                  echo "| **Package Manager** | APT | Stable, mature package ecosystem" >> $GITHUB_STEP_SUMMARY
                  echo "| **glibc Implementation** | Native Ubuntu glibc | Perfect x86 compatibility without layers" >> $GITHUB_STEP_SUMMARY
                  echo "| **Compiler Toolchain** | LLVM ${{ env.LLVM_VERSION }} native Ubuntu | Well-tested Ubuntu packages" >> $GITHUB_STEP_SUMMARY
                  echo "| **Build System** | CMake + Ninja | Ubuntu-tuned build environment" >> $GITHUB_STEP_SUMMARY
                  echo "| **Container Engine** | Docker BuildKit | Enhanced layer efficiency with Ubuntu" >> $GITHUB_STEP_SUMMARY
                  echo "| **Security Model** | Ubuntu LTS security | Regular security updates until 2029" >> $GITHUB_STEP_SUMMARY
                  echo "| **Target Platform** | linux/arm64 | Native ARM64 execution" >> $GITHUB_STEP_SUMMARY
                  echo "| **Emulation Target** | x86/x86_64 | Perfect compatibility maintained" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY

                  # Ubuntu-specific quality assurance 
                  echo "## üß™ Ubuntu Quality Assurance Results" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  if [ -n "$FILTERED_MATRIX" ] && [ "$FILTERED_MATRIX" != "null" ]; then
                      MATRIX_SIZE=$(echo "$FILTERED_MATRIX" | jq '.include | length' 2>/dev/null || echo "0")
                      echo "- **Verification Coverage**: Ubuntu-specific comprehensive testing for all $MATRIX_SIZE distributions" >> $GITHUB_STEP_SUMMARY
                  else
                      echo "- **Verification Coverage**: Not available due to matrix generation issues" >> $GITHUB_STEP_SUMMARY
                  fi
                  echo "- **Test Categories**: Binary validation, RootFS integrity, Ubuntu glibc compatibility, emulation functionality" >> $GITHUB_STEP_SUMMARY
                  echo "- **Ubuntu Compatibility**: Native glibc verification for x86 emulation" >> $GITHUB_STEP_SUMMARY
                  echo "- **Performance Verification**: x86_64 architecture emulation validation on Ubuntu base" >> $GITHUB_STEP_SUMMARY
                  echo "- **Security Validation**: Ubuntu LTS security model with non-root execution" >> $GITHUB_STEP_SUMMARY
                  echo "- **Multi-RootFS Testing**: Ubuntu/Fedora RootFS compatibility with Ubuntu base" >> $GITHUB_STEP_SUMMARY
                  echo "- **Registry Validation**: Both Docker Hub and GHCR deployment verification for Ubuntu images" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY

                  # Footer with Ubuntu-specific achievements
                  echo "---" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "## üöÄ Next Steps (Ubuntu-Optimized)" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "1. **Download Ubuntu Images**: Pull stable images from [Docker Hub](${{ env.DOCKERHUB_REPO }}) or [GHCR](${{ env.REGISTRY }}/${{ env.IMAGE_NAME }})" >> $GITHUB_STEP_SUMMARY
                  echo "2. **Experience the Stability**: Notice Ubuntu LTS reliability and native glibc compatibility" >> $GITHUB_STEP_SUMMARY
                  echo "3. **Read Documentation**: Check the [Repository README](https://github.com/${{ github.repository }}) for Ubuntu-specific guidance" >> $GITHUB_STEP_SUMMARY
                  echo "4. **Join Community**: Connect via [GitHub Discussions](https://github.com/${{ github.repository }}/discussions)" >> $GITHUB_STEP_SUMMARY
                  echo "5. **Report Issues**: Submit bugs at [GitHub Issues](https://github.com/${{ github.repository }}/issues)" >> $GITHUB_STEP_SUMMARY
                  echo "6. **Share the Stability**: Help others discover Ubuntu LTS benefits" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**üéâ Ubuntu-optimized build completed successfully with maximum compatibility and LTS stability!**" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**üèóÔ∏è Ubuntu Achievement**: Native glibc compatibility with 5-year LTS support lifecycle" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "*Generated on $(date '+%Y-%m-%d %H:%M:%S UTC') by [FEXBash Ubuntu Builder V4](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*" >> $GITHUB_STEP_SUMMARY

            - name: Close tracking issue if build successful
              if: needs.build-arm.result == 'success' && needs.merge-manifests.result == 'success'
              uses: actions/github-script@v7
              with:
                  script: |
                      // Find related automation issues
                      const issues = await github.rest.issues.listForRepo({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          labels: 'automation,build-trigger',
                          state: 'open'
                      });

                      const buildVersion = '${{ needs.prepare-and-generate.outputs.fex_semantic }}';

                      for (const issue of issues.data) {
                          if (issue.title.includes(buildVersion) || issue.title.includes('FEX Release')) {
                          await github.rest.issues.createComment({
                              owner: context.repo.owner,
                              repo: context.repo.repo,
                              issue_number: issue.number,
                              body: `
                              ## ‚úÖ Build Completed Successfully
                              
                              **Build Status**: üéâ Success
                              **Completion Time**: ${new Date().toISOString()}
                              **Workflow Run**: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
                              
                              ### üì¶ Generated Images:
                              - Docker Hub: \`supersunho/fex-emu\` with new tags
                              - Registry manifests updated
                              - All quality checks passed
                              
                              Automatically closing this tracking issue.
                              `
                          });
                          
                          await github.rest.issues.update({
                              owner: context.repo.owner,
                              repo: context.repo.repo,
                              issue_number: issue.number,
                              state: 'closed'
                          });
                          }
                      }
