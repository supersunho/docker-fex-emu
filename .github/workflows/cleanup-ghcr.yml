name: GHCR Package Cleanup

on:
    workflow_dispatch:
        inputs:
            cleanup_mode:
                description: "ì •ë¦¬ ëª¨ë“œ ì„ íƒ"
                required: true
                default: "selective"
                type: choice
                options:
                    - "selective"
                    - "delete_all"
                    - "by_pattern"
                    - "keep_latest"

            tag_pattern:
                description: "ì‚­ì œí•  íƒœê·¸ íŒ¨í„´ (ì˜ˆ: dev-*, pr-*, feature-*)"
                required: false
                default: "dev-*,pr-*"
                type: string

            exclude_tags:
                description: "ì œì™¸í•  íƒœê·¸ë“¤ (ì‰¼í‘œë¡œ êµ¬ë¶„)"
                required: false
                default: "main,latest,stable"
                type: string

            keep_n_tagged:
                description: "ë³´ì¡´í•  íƒœê·¸ëœ ì´ë¯¸ì§€ ìˆ˜"
                required: false
                default: "5"
                type: string

            keep_n_untagged:
                description: "ë³´ì¡´í•  íƒœê·¸ ì—†ëŠ” ì´ë¯¸ì§€ ìˆ˜"
                required: false
                default: "2"
                type: string

            delete_untagged:
                description: "íƒœê·¸ ì—†ëŠ” ì´ë¯¸ì§€ ì‚­ì œ"
                required: true
                default: true
                type: boolean

            dry_run:
                description: "ë“œë¼ì´ëŸ° ëª¨ë“œ (ì‹¤ì œ ì‚­ì œí•˜ì§€ ì•ŠìŒ)"
                required: true
                default: true
                type: boolean

            package_name:
                description: "íŒ¨í‚¤ì§€ ì´ë¦„ (ê¸°ë³¸ê°’: ì €ì¥ì†Œ ì´ë¦„)"
                required: false
                type: string

jobs:
    cleanup-ghcr:
        runs-on: ubuntu-latest
        permissions:
            packages: write
            contents: read

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: ì…ë ¥ ê°’ í™•ì¸
              run: |
                  echo "ğŸ§¹ GHCR íŒ¨í‚¤ì§€ ì •ë¦¬ ì‹œì‘"
                  echo "ì •ë¦¬ ëª¨ë“œ: ${{ github.event.inputs.cleanup_mode }}"
                  echo "íƒœê·¸ íŒ¨í„´: ${{ github.event.inputs.tag_pattern }}"
                  echo "ì œì™¸ íƒœê·¸: ${{ github.event.inputs.exclude_tags }}"
                  echo "ë³´ì¡´í•  íƒœê·¸ëœ ì´ë¯¸ì§€: ${{ github.event.inputs.keep_n_tagged }}"
                  echo "ë³´ì¡´í•  íƒœê·¸ ì—†ëŠ” ì´ë¯¸ì§€: ${{ github.event.inputs.keep_n_untagged }}"
                  echo "íƒœê·¸ ì—†ëŠ” ì´ë¯¸ì§€ ì‚­ì œ: ${{ github.event.inputs.delete_untagged }}"
                  echo "ë“œë¼ì´ëŸ° ëª¨ë“œ: ${{ github.event.inputs.dry_run }}"
                  echo "íŒ¨í‚¤ì§€ ì´ë¦„: ${{ github.event.inputs.package_name || github.repository }}"

            - name: ì„ íƒì  ì •ë¦¬ ëª¨ë“œ
              if: github.event.inputs.cleanup_mode == 'selective'
              uses: dataaxiom/ghcr-cleanup-action@v1
              with:
                  dry-run: ${{ github.event.inputs.dry_run }}
                  delete-tags: ${{ github.event.inputs.tag_pattern }}
                  delete-untagged: ${{ github.event.inputs.delete_untagged }}
                  keep-n-tagged: ${{ github.event.inputs.keep_n_tagged }}
                  keep-n-untagged: ${{ github.event.inputs.keep_n_untagged }}
                  exclude-tags: ${{ github.event.inputs.exclude_tags }}
                  package: ${{ github.event.inputs.package_name || github.repository }}

            - name: ì „ì²´ ì‚­ì œ ëª¨ë“œ
              if: github.event.inputs.cleanup_mode == 'delete_all'
              uses: dataaxiom/ghcr-cleanup-action@v1
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  dry-run: ${{ github.event.inputs.dry_run }}
                  delete-tags: "*"
                  delete-untagged: true
                  package: ${{ github.event.inputs.package_name || github.repository }}

            - name: íŒ¨í„´ ê¸°ë°˜ ì‚­ì œ ëª¨ë“œ
              if: github.event.inputs.cleanup_mode == 'by_pattern'
              uses: jenskeiner/ghcr-container-repository-cleanup-action@main
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  include-tags: ${{ github.event.inputs.tag_pattern }}
                  exclude-tags: ${{ github.event.inputs.exclude_tags }}
                  dry-run: ${{ github.event.inputs.dry_run }}
                  owner: ${{ github.repository_owner }}
                  repository: ${{ github.event.inputs.package_name || github.event.repository.name }}

            - name: ìµœì‹  ë²„ì „ ìœ ì§€ ëª¨ë“œ
              if: github.event.inputs.cleanup_mode == 'keep_latest'
              uses: cresh-io/action-ghcr-batch-delete-versions@v1
              with:
                  github-access-token: ${{ secrets.GITHUB_TOKEN }}
                  org: ${{ github.repository_owner }}
                  package_name: ${{ github.event.inputs.package_name || github.event.repository.name }}
                  package_type: "container"
                  dry-run: ${{ github.event.inputs.dry_run }}
                  selector: |
                      type=tagCount;operator=greaterThan;value=${{ github.event.inputs.keep_n_tagged }}
                  excluder: |
                      type=tags;operator=in;value=${{ github.event.inputs.exclude_tags }}

            - name: ì •ë¦¬ ê²°ê³¼ ìš”ì•½
              run: |
                  echo "âœ… GHCR íŒ¨í‚¤ì§€ ì •ë¦¬ ì™„ë£Œ"
                  echo "ì‚¬ìš©ëœ ëª¨ë“œ: ${{ github.event.inputs.cleanup_mode }}"
                  if [[ "${{ github.event.inputs.dry_run }}" == "true" ]]; then
                    echo "âš ï¸ ë“œë¼ì´ëŸ° ëª¨ë“œë¡œ ì‹¤í–‰ë¨ - ì‹¤ì œ ì‚­ì œë˜ì§€ ì•ŠìŒ"
                    echo "ì‹¤ì œ ì‚­ì œë¥¼ ì›í•˜ë©´ 'dry_run'ì„ falseë¡œ ì„¤ì •í•˜ì„¸ìš”"
                  else
                    echo "ğŸ—‘ï¸ ì‹¤ì œ ì‚­ì œê°€ ìˆ˜í–‰ë¨"
                  fi

            # - name: Slack ì•Œë¦¼ (ì„ íƒì‚¬í•­)
            #   if: always()
            #   uses: 8398a7/action-slack@v3
            #   with:
            #       status: ${{ job.status }}
            #       channel: "#deployments"
            #       text: |
            #           GHCR íŒ¨í‚¤ì§€ ì •ë¦¬ ${{ job.status }}
            #           ëª¨ë“œ: ${{ github.event.inputs.cleanup_mode }}
            #           ë“œë¼ì´ëŸ°: ${{ github.event.inputs.dry_run }}
            #   env:
            #       SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
